(()=>{var e,r,t,o,n,l,a,s,i={4098:(e,r,t)=>{"use strict";var o=t(4117),n=t(6927);function l(e){let r=0,t=0;e.forEach(e=>{r+=e.x,t+=e.y}),r/=e.length,t/=e.length;let n=0;e.forEach(e=>{n+=Math.sqrt((e.x-r)**2+(e.y-t)**2)});let l=Math.sqrt(2)/(n/=e.length),a=new o.uq([[l,0,-l*r],[0,l,-l*t],[0,0,1]]);return{points:e.map(e=>{let r=new o.uq([[e.x],[e.y],[1]]),t=a.mmul(r);return{x:t.get(0,0),y:t.get(1,0)}}),T:a}}let a=null,s=null,i=null,u=null,c=null,d=null,f=!1,g="";async function p(e){if(!f)return new Promise(async(e,r)=>{let o={onRuntimeInitialized:()=>{console.log("[Worker] OpenCV Runtime Initialized via Module callback"),d=self.cv&&self.cv.Mat?self.cv:o,f=!0,e()},onError:e=>{console.error("[Worker] OpenCV Module Error:",e)},print:e=>console.log("[OpenCV]",e),printErr:e=>console.warn("[OpenCV]",e)};self.Module=o,self.module=void 0,self.exports=void 0,self.define=void 0,self.window||(self.window=self),self.process=void 0,console.log("[Worker] Initializing bundled OpenCV via dynamic import...");try{let r=await Promise.all([t.e(268),t.e(672),t.e(571)]).then(t.t.bind(t,7571,23)),n=r.default||r;if("function"==typeof n){let r=n(o);r&&"function"==typeof r.then?r.then(r=>{console.log("[Worker] Bundled OpenCV factory promise resolved"),d=r,f=!0,e()}):r&&r.Mat&&(console.log("[Worker] Bundled OpenCV factory returned instance"),d=r,f=!0,e())}else n&&n.Mat&&(console.log("[Worker] Bundled OpenCV is already an instance"),d=n,f=!0,e())}catch(e){console.warn("[Worker] Failed to initialize bundled OpenCV:",e)}let n=0,l=setInterval(()=>{n++;let r=self.cv,t=self.Module?self.Module.cv:null;r&&r.Mat?(clearInterval(l),f||(console.log("[Worker] OpenCV found via Polling (global.cv)"),d=r,f=!0,e())):t&&t.Mat&&(clearInterval(l),f||(console.log("[Worker] OpenCV found via Polling (Module.cv)"),d=t,f=!0,e())),n>200&&n%50==0&&console.warn("[Worker] Still waiting for OpenCV...")},100)})}let m=null;async function y(e,r){let{boardType:t}=r;if("aprilgrid"===t){if(!a){console.warn("[Worker] AprilTag module not ready yet, waiting...");for(let e=0;e<50&&!a;e++)await new Promise(e=>setTimeout(e,100));if(!a)throw Error("AprilTag not initialized after waiting")}return h({imageData:e})}if("checkerboard"===t||"chessboard"===t)return await p(g),function(e,r){try{let{rows:t,cols:o}=r;if(console.log(`[Worker] Detecting Chessboard: ${o}x${t} (inner corners)`),!d)return console.error("[Worker] OpenCV not loaded"),{found:!1,corners:[],error:"OpenCV not loaded"};let n=d.matFromImageData(e),l=new d.Mat;d.cvtColor(n,l,d.COLOR_RGBA2GRAY);let a=new d.Mat,s=new d.Size(o,t);console.log(`[Worker] Attempt 1: ${o}x${t}`);let i=d.findChessboardCorners(l,s,a,3);if(i||(console.log("[Worker] Attempt 1 failed. Trying (cols-1)x(rows-1)..."),s=new d.Size(o-1,t-1),i=d.findChessboardCorners(l,s,a,3)),i||(console.log("[Worker] Attempt 2 failed. Trying swapped cols/rows..."),s=new d.Size(t,o),i=d.findChessboardCorners(l,s,a,3)),i){console.log(`[Worker] Checkerboard found! Size: ${s.width}x${s.height}`);let e=new d.Size(5,5),r=new d.Size(-1,-1),t=new d.TermCriteria(d.TERM_CRITERIA_EPS+d.TERM_CRITERIA_COUNT,30,.001);d.cornerSubPix(l,a,e,r,t);let o=[];for(let e=0;e<a.rows;++e)o.push({x:a.data32F[2*e],y:a.data32F[2*e+1]});return n.delete(),l.delete(),a.delete(),{found:!0,corners:o}}return console.log("[Worker] Checkerboard NOT found."),n.delete(),l.delete(),a.delete(),{found:!1,corners:[],error:"Checkerboard pattern not found. Tried normal, inner-corners, and swapped dimensions."}}catch(e){return console.error("OpenCV Checkerboard Error:",e),{found:!1,corners:[],error:`OpenCV Error: ${e.message||e}`}}}(e,r);if("charuco"===t)return await p(g),function(e,r){if(!d.aruco)return console.error("OpenCV build does not support ArUco"),{found:!1,error:"ArUco module not found in OpenCV build"};try{let{rows:t,cols:o,squareSize:n,markerSize:l,dictionary:a}=r,s=d.matFromImageData(e),i=new d.Mat;d.cvtColor(s,i,d.COLOR_RGBA2GRAY);let u=d.aruco.getPredefinedDictionary(d.aruco[a]),c=new d.aruco.CharucoBoard(o,t,n,l,u),f=new d.Mat,g=new d.Mat,p=new d.Mat,m=new d.aruco.DetectorParameters;if(d.aruco.detectMarkers(i,u,f,g,m,p),g.rows>0){let e=new d.Mat,r=new d.Mat;if(d.aruco.interpolateCornersCharuco(f,g,i,c,e,r)>0){let t=[];for(let o=0;o<e.rows;++o)t.push({x:e.data32F[2*o],y:e.data32F[2*o+1],id:r.data32S[o]});return s.delete(),i.delete(),f.delete(),g.delete(),p.delete(),e.delete(),r.delete(),c.delete(),m.delete(),u.delete(),{found:!0,corners:t,isCharuco:!0}}return s.delete(),i.delete(),f.delete(),g.delete(),p.delete(),c.delete(),m.delete(),{found:!1,corners:[],error:"Markers found but ChArUco board interpolation failed (count=0)."}}return s.delete(),i.delete(),f.delete(),g.delete(),p.delete(),c.delete(),m.delete(),{found:!1,corners:[],error:"No ArUco markers detected for ChArUco board."}}catch(e){return console.error("OpenCV ChArUco Error:",e),{found:!1,corners:[],error:`OpenCV ChArUco Error: ${e.message||e}`}}}(e,r);throw Error(`Unknown board type: ${t}`)}async function w(e){if(!a)return new Promise((r,t)=>{let o=new URL(e,self.location.origin).toString();self.postMessage({type:"LOG",message:`Loading script from: ${o}`}),self.Module={locateFile:e=>{if(e.endsWith(".wasm")){if(g){let e=new URL("apriltag.wasm",g).href;return self.postMessage({type:"LOG",message:`Locating WASM at: ${e}`}),e}return new URL("/apriltag.wasm",self.location.origin).toString()}return e},onRuntimeInitialized:()=>{console.log("AprilTag WASM Initialized"),self.postMessage({type:"LOG",message:"WASM Runtime Initialized"})}};try{importScripts(o),self.postMessage({type:"LOG",message:"importScripts executed successfully"})}catch(e){self.postMessage({type:"LOG",message:`importScripts failed: ${e.message}`}),t(e);return}let n=async()=>{if(self.AprilTagWasm){self.postMessage({type:"LOG",message:"AprilTagWasm factory found. Initializing module..."});try{a=await self.AprilTagWasm(self.Module),self.postMessage({type:"LOG",message:"Module awaited successfully"}),i=a.cwrap("atagjs_init","number",[]),a.cwrap("atagjs_destroy","number",[]),c=a.cwrap("atagjs_set_detector_options","number",["number","number","number","number","number","number","number"]),u=a.cwrap("atagjs_set_img_buffer","number",["number","number","number"]),s=a.cwrap("atagjs_detect","number",[]);let e=i();console.log("atag_init returned:",e),c(2,0,1,1,10,0,0),console.log("AprilTag WASM Initialized (Safe Options Set)"),r()}catch(e){self.postMessage({type:"LOG",message:`WASM Module Instantiation failed: ${e.message}`}),t(e)}}else setTimeout(n,100)};n()})}function h({imageData:e}){let{width:r,height:t,data:o}=e,n=new Uint8Array(r*t);for(let e=0;e<r*t;e++){let r=o[4*e],t=o[4*e+1],l=o[4*e+2];n[e]=.299*r+.587*t+.114*l}console.log(`[Worker] Image size: ${r}x${t}, Buffer size: ${n.length}`);let l=u(r,t,r);if(0===l)throw Error("Failed to allocate memory for image in WASM");a.HEAPU8.set(n,l);let i=s();if(console.log("[Worker] Detect Result Ptr:",i),0===i)return console.error("[Worker] Detection failed: returned NULL pointer"),{found:!1,detections:[],error:"WASM Internal Error: Returned NULL pointer"};let c=a.getValue(i,"i32"),d=a.getValue(i+4,"i32");if(console.log("[Worker] JSON Ptr:",c,"Len:",d),d>0&&0!==c)try{let e=a.HEAPU8.subarray(c,c+d),r=new TextDecoder("utf8").decode(e);if(console.log("[Worker] JSON String Start:",r.substring(0,100)),!(r=r.replace(/\u0000/g,"")).trim().startsWith("["))return console.error("[Worker] Invalid JSON format (does not start with [). Full string:",r),{found:!1,detections:[],error:`WASM Output Error: ${r}`};let t=JSON.parse(r);if(0===t.length)return{found:!1,detections:[],error:"No AprilTags detected"};return{found:t.length>0,detections:t}}catch(e){return console.error("[Worker] JSON Parse Error:",e.message),{found:!1,detections:[],error:`JSON Parse Error: ${e.message}`}}return{found:!1,detections:[],error:"No detection result returned from WASM"}}self.onmessage=async e=>{let{type:r,payload:t,id:s}=e.data;try{switch(r){case"INIT":self.postMessage({type:"LOG",message:`INIT received. URL: ${t.url}`}),t.baseUrl&&(g=t.baseUrl,self.postMessage({type:"LOG",message:`Global Base URL set to: ${g}`})),m=w(t.url),await m,self.postMessage({type:"INIT_SUCCESS",id:s});break;case"DETECT":m&&await m;let e=await y(t.imageData,t.settings);self.postMessage({type:"DETECT_SUCCESS",id:s,payload:e});break;case"DETECT_TAGS":if(!a)throw Error("AprilTag not initialized");let i=h(t);self.postMessage({type:"DETECT_SUCCESS",id:s,payload:i});break;case"CALIBRATE":let u=function(e,r,t){let a,s,i,u,c,d,f,g,p,m,y,w,h,b,C=[],{points:O,T:S}=l(r);for(let r of e){let{points:e,T:t}=l(r),n=function(e,r){let t=e.length,n=[];for(let o=0;o<t;o++){let t=e[o].x,l=e[o].y,a=r[o].x,s=r[o].y;n.push([-t,-l,-1,0,0,0,a*t,a*l,a]),n.push([0,0,0,-t,-l,-1,s*t,s*l,s])}let l=new o.uq(n),a=new o.W2(l).rightSingularVectors.getColumn(8),s=new o.uq(3,3);return s.set(0,0,a[0]),s.set(0,1,a[1]),s.set(0,2,a[2]),s.set(1,0,a[3]),s.set(1,1,a[4]),s.set(1,2,a[5]),s.set(2,0,a[6]),s.set(2,1,a[7]),s.set(2,2,a[8]),s}(O,e),a=(0,o.DI)(t).mmul(n).mmul(S);a.div(a.get(2,2)),C.push(a)}let M=(a=new o.uq(2*C.length,6),s=(e,r,t)=>{let o=e.getColumn(r),n=e.getColumn(t);return[o[0]*n[0],o[0]*n[1]+o[1]*n[0],o[1]*n[1],o[2]*n[0]+o[0]*n[2],o[2]*n[1]+o[1]*n[2],o[2]*n[2]]},C.forEach((e,r)=>{let t=s(e,0,1),o=s(e,0,0),n=s(e,1,1),l=o.map((e,r)=>e-n[r]);for(let e=0;e<6;e++)a.set(2*r,e,t[e]),a.set(2*r+1,e,l[e])}),u=(i=new o.W2(a).rightSingularVectors.getColumn(5))[0],c=i[1],d=i[2],f=i[3],g=i[4],p=i[5],m=(c*f-u*g)/(u*d-c*c),y=p-(f*f+m*(c*f-u*g))/u,w=Math.sqrt(y/u),h=Math.sqrt(y*u/(u*d-c*c)),b=-c*w*w*h/y,{fx:w,fy:h,cx:b*m/h-f*w*w/y,cy:m,skew:b}),k=new o.uq([[M.fx,M.skew,M.cx],[0,M.fy,M.cy],[0,0,1]]),v=C.map(e=>(function(e,r){let t=(0,o.DI)(r),n=e.getColumn(0),l=e.getColumn(1),a=e.getColumn(2),s=new o.uq(3,1);for(let e=0;e<3;e++)s.set(e,0,n[e]);s.norm();let i=new o.uq(3,1);for(let e=0;e<3;e++)i.set(e,0,n[e]);let u=new o.uq(3,1);for(let e=0;e<3;e++)u.set(e,0,l[e]);let c=new o.uq(3,1);for(let e=0;e<3;e++)c.set(e,0,a[e]);let d=t.mmul(i),f=t.mmul(u),g=t.mmul(c),p=1/d.norm(),m=d.mul(p),y=f.mul(p),w=new o.uq([[m.get(1,0)*y.get(2,0)-m.get(2,0)*y.get(1,0)],[m.get(2,0)*y.get(0,0)-m.get(0,0)*y.get(2,0)],[m.get(0,0)*y.get(1,0)-m.get(1,0)*y.get(0,0)]]),h=g.mul(p),b=new o.uq(3,3);b.setColumn(0,m.to1DArray()),b.setColumn(1,y.to1DArray()),b.setColumn(2,w.to1DArray());let C=new o.W2(b);return{R:C.leftSingularVectors.mmul(C.rightSingularVectors.transpose()),t:h}})(e,k)),E=[M.fx,M.fy,M.cx,M.cy,0,0],T=[],A=[];e.forEach((e,r)=>{e.forEach((e,t)=>{T.push([r,t,0]),A.push(e.x),T.push([r,t,1]),A.push(e.y)})});let W=(0,n.s)({x:T,y:A},(e,t)=>{let[n,l,a,s,i,u]=t;return e.map(e=>{let t=e[0],c=e[1],d=1===e[2],{R:f,t:g}=v[t],p=r[c],m=new o.uq([[p.x],[p.y],[0]]),y=f.mmul(m).add(g),w=y.get(0,0)/y.get(2,0),h=y.get(1,0)/y.get(2,0),b=w*w+h*h,C=b*b;return d?h*(1+i*b+u*C)*l+s:w*(1+i*b+u*C)*n+a})},{damping:1.5,initialValues:E,gradientDifference:.1,maxIterations:50,errorTolerance:.01}),[x,_,I,R,L,P]=W.parameterValues;return{cameraMatrix:[x,0,I,0,_,R,0,0,1],distCoeffs:[L,P,0,0,0],rms:W.parameterError,rvecs:v.map(e=>[0,0,0]),tvecs:v.map(e=>[e.t.get(0,0),e.t.get(1,0),e.t.get(2,0)])}}(t.allImagePoints,t.objPoints,t.imageSize);self.postMessage({type:"CALIBRATE_SUCCESS",id:s,payload:u});break;default:throw Error(`Unknown message type: ${r}`)}}catch(e){self.postMessage({type:"ERROR",id:s,error:e.message})}}}},u={};function c(e){var r=u[e];if(void 0!==r)return r.exports;var t=u[e]={exports:{}},o=!0;try{i[e](t,t.exports,c),o=!1}finally{o&&delete u[e]}return t.exports}c.m=i,c.x=()=>{var e=c.O(void 0,[927],()=>c(4098));return c.O(e)},e=[],c.O=(r,t,o,n)=>{if(t){n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[t,o,n];return}for(var a=1/0,l=0;l<e.length;l++){for(var[t,o,n]=e[l],s=!0,i=0;i<t.length;i++)(!1&n||a>=n)&&Object.keys(c.O).every(e=>c.O[e](t[i]))?t.splice(i--,1):(s=!1,n<a&&(a=n));if(s){e.splice(l--,1);var u=o();void 0!==u&&(r=u)}}return r},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,c.t=function(e,o){if(1&o&&(e=this(e)),8&o||"object"==typeof e&&e&&(4&o&&e.__esModule||16&o&&"function"==typeof e.then))return e;var n=Object.create(null);c.r(n);var l={};r=r||[null,t({}),t([]),t(t)];for(var a=2&o&&e;"object"==typeof a&&!~r.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach(r=>l[r]=()=>e[r]);return l.default=()=>e,c.d(n,l),n},c.d=(e,r)=>{for(var t in r)c.o(r,t)&&!c.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},c.f={},c.e=e=>Promise.all(Object.keys(c.f).reduce((r,t)=>(c.f[t](e,r),r),[])),c.u=e=>"static/chunks/"+(268===e?"aaea2bcf":e)+"."+({268:"6a2560b34eba8af9",571:"664805e431825830",672:"709871283765441f",927:"3fd8a9bb48a63997"})[e]+".js",c.miniCssF=e=>{},c.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),c.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.tt=()=>(void 0===o&&(o={createScriptURL:e=>e},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(o=trustedTypes.createPolicy("nextjs#bundler",o))),o),c.tu=e=>c.tt().createScriptURL(e),c.p="/camera_calibrator/_next/",n={98:1},c.f.i=(e,r)=>{n[e]||importScripts(c.tu(c.p+c.u(e)))},a=(l=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(l),l.push=e=>{var[r,t,o]=e;for(var l in t)c.o(t,l)&&(c.m[l]=t[l]);for(o&&o(c);r.length;)n[r.pop()]=1;a(e)},s=c.x,c.x=()=>c.e(927).then(s),_N_E=c.x()})();