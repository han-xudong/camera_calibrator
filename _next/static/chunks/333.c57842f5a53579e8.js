(()=>{var e,t,r,n,a,l,o={1333:(e,t,r)=>{"use strict";var n=r(4117),a=r(6927);function l(e){let t=0,r=0;e.forEach(e=>{t+=e.x,r+=e.y}),t/=e.length,r/=e.length;let a=0;e.forEach(e=>{a+=Math.sqrt((e.x-t)**2+(e.y-r)**2)});let l=Math.sqrt(2)/(a/=e.length),o=new n.uq([[l,0,-l*t],[0,l,-l*r],[0,0,1]]);return{points:e.map(e=>{let t=new n.uq([[e.x],[e.y],[1]]),r=o.mmul(t);return{x:r.get(0,0),y:r.get(1,0)}}),T:o}}function o(e){let t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(t<1e-8)return n.uq.eye(3);let r=new n.uq([[e[0]/t],[e[1]/t],[e[2]/t]]),a=new n.uq([[0,-r.get(2,0),r.get(1,0)],[r.get(2,0),0,-r.get(0,0)],[-r.get(1,0),r.get(0,0),0]]),l=n.uq.eye(3),o=a.mmul(a),s=a.mul(Math.sin(t)),u=o.mul(1-Math.cos(t));return l.add(s).add(u)}let s=null,u=null,i=null,g=null,c=null;async function m(e,t){let{boardType:r}=t;if("aprilgrid"===r){if(!s)throw Error("AprilTag not initialized");return function({imageData:e}){let{width:t,height:r,data:n}=e,a=new Uint8Array(t*r);for(let e=0;e<t*r;e++){let t=n[4*e],r=n[4*e+1],l=n[4*e+2];a[e]=.299*t+.587*r+.114*l}let l=g(t,r,t);if(0===l)throw Error("Failed to allocate memory for image in WASM");s.HEAPU8.set(a,l);let o=u();if(0===o)return{found:!1,detections:[],error:"WASM Internal Error: Returned NULL pointer"};let i=s.getValue(o,"i32"),c=s.getValue(o+4,"i32");if(c>0&&0!==i)try{let e=s.HEAPU8.subarray(i,i+c),t=new TextDecoder("utf8").decode(e);if(!(t=t.replace(/\u0000/g,"")).trim().startsWith("["))return{found:!1,detections:[],error:`WASM Output Error: ${t}`};let r=JSON.parse(t);return{found:r.length>0,detections:r}}catch(e){return{found:!1,detections:[],error:`JSON Parse Error: ${e.message}`}}return{found:!1,detections:[],error:"No detection result returned from WASM"}}({imageData:e})}if("checkerboard"===r||"chessboard"===r)throw Error("Please use backend for chessboard detection.");if("charuco"===r)throw Error("ChArUco detection not yet implemented in worker.");throw Error(`Unknown board type: ${r}`)}async function f(e){if(!s)return new Promise((t,r)=>{let n=new URL(e,self.location.origin).toString();self.Module={locateFile:t=>t.endsWith(".wasm")?new URL("apriltag.wasm",e.substring(0,e.lastIndexOf("/")+1)).toString():t,onRuntimeInitialized:()=>{console.log("AprilTag WASM Initialized")}},importScripts(n),self.postMessage({type:"PROGRESS",message:"Loading AprilTag WASM..."});let a=async()=>{if(self.AprilTagWasm)try{self.postMessage({type:"PROGRESS",message:"Initializing AprilTag..."});let e=new Promise(async(e,t)=>{let r=setTimeout(()=>t(Error("AprilTagWasm factory timeout")),1e4);try{let t=await self.AprilTagWasm(self.Module);clearTimeout(r),e(t)}catch(e){clearTimeout(r),t(e)}});i=(s=await e).cwrap("atagjs_init","number",[]),s.cwrap("atagjs_destroy","number",[]),c=s.cwrap("atagjs_set_detector_options","number",["number","number","number","number","number","number","number"]),g=s.cwrap("atagjs_set_img_buffer","number",["number","number","number"]),u=s.cwrap("atagjs_detect","number",[]);let r=i();console.log("atag_init returned:",r),c(2,0,1,1,10,0,0),console.log("AprilTag WASM Initialized (Safe Options Set)"),t()}catch(e){console.error("AprilTag WASM Init Failed:",e),r(e)}else setTimeout(a,100)};a()})}self.onmessage=async e=>{let{type:t,payload:r,id:s}=e.data;try{switch(t){case"INIT":r.url,await f(r.url),self.postMessage({type:"INIT_SUCCESS",id:s});break;case"DETECT":let e=await m(r.imageData,r.settings);self.postMessage({type:"DETECT_SUCCESS",id:s,payload:e});break;case"CALIBRATE":let u=function(e,t,r){let s,u,i,g,c,m,f,p,d,h,y,w,b,S,E=[],{points:M,T:x}=l(t);for(let t of e){let{points:e,T:r}=l(t),a=function(e,t){let r=e.length,a=[];for(let n=0;n<r;n++){let r=e[n].x,l=e[n].y,o=t[n].x,s=t[n].y;a.push([-r,-l,-1,0,0,0,o*r,o*l,o]),a.push([0,0,0,-r,-l,-1,s*r,s*l,s])}let l=new n.uq(a),o=new n.W2(l).rightSingularVectors.getColumn(8),s=new n.uq(3,3);return s.set(0,0,o[0]),s.set(0,1,o[1]),s.set(0,2,o[2]),s.set(1,0,o[3]),s.set(1,1,o[4]),s.set(1,2,o[5]),s.set(2,0,o[6]),s.set(2,1,o[7]),s.set(2,2,o[8]),s}(M,e),o=(0,n.DI)(r).mmul(a).mmul(x);o.div(o.get(2,2)),E.push(o)}let A=(s=new n.uq(2*E.length,6),u=(e,t,r)=>{let n=e.getColumn(t),a=e.getColumn(r);return[n[0]*a[0],n[0]*a[1]+n[1]*a[0],n[1]*a[1],n[2]*a[0]+n[0]*a[2],n[2]*a[1]+n[1]*a[2],n[2]*a[2]]},E.forEach((e,t)=>{let r=u(e,0,1),n=u(e,0,0),a=u(e,1,1),l=n.map((e,t)=>e-a[t]);for(let e=0;e<6;e++)s.set(2*t,e,r[e]),s.set(2*t+1,e,l[e])}),g=(i=new n.W2(s).rightSingularVectors.getColumn(5))[0],c=i[1],m=i[2],f=i[3],p=i[4],d=i[5],h=(c*f-g*p)/(g*m-c*c),y=d-(f*f+h*(c*f-g*p))/g,w=Math.sqrt(Math.abs(y/g)),b=Math.sqrt(Math.abs(y*g/(g*m-c*c))),S=-c*w*w*b/y,{fx:w,fy:b,cx:S*h/b-f*w*w/y,cy:h,skew:S}),C=new n.uq([[A.fx,A.skew,A.cx],[0,A.fy,A.cy],[0,0,1]]),T=E.map(e=>(function(e,t){let r=(0,n.DI)(t),a=e.getColumn(0),l=e.getColumn(1),o=e.getColumn(2),s=new n.uq(3,1);for(let e=0;e<3;e++)s.set(e,0,a[e]);s.norm();let u=new n.uq(3,1);for(let e=0;e<3;e++)u.set(e,0,a[e]);let i=new n.uq(3,1);for(let e=0;e<3;e++)i.set(e,0,l[e]);let g=new n.uq(3,1);for(let e=0;e<3;e++)g.set(e,0,o[e]);let c=r.mmul(u),m=r.mmul(i),f=r.mmul(g),p=1/c.norm(),d=c.mul(p),h=m.mul(p),y=new n.uq([[d.get(1,0)*h.get(2,0)-d.get(2,0)*h.get(1,0)],[d.get(2,0)*h.get(0,0)-d.get(0,0)*h.get(2,0)],[d.get(0,0)*h.get(1,0)-d.get(1,0)*h.get(0,0)]]),w=f.mul(p),b=new n.uq(3,3);b.setColumn(0,d.to1DArray()),b.setColumn(1,h.to1DArray()),b.setColumn(2,y.to1DArray());let S=new n.W2(b),E=S.leftSingularVectors.mmul(S.rightSingularVectors.transpose());if(0>w.get(2,0)){w.mul(-1),d.mul(-1),h.mul(-1),b.setColumn(0,d.to1DArray()),b.setColumn(1,h.to1DArray()),b.setColumn(2,y.to1DArray());let e=new n.W2(b);return{R:e.leftSingularVectors.mmul(e.rightSingularVectors.transpose()),t:w}}return{R:E,t:w}})(e,C)),q=[A.fx,A.fy,A.cx,A.cy,0,0];T.forEach(e=>{let t=function(e){let t=(e.trace()-1)/2;t>1&&(t=1),t<-1&&(t=-1);let r=Math.acos(t);if(1e-8>Math.abs(r))return[0,0,0];let n=r/(2*Math.sin(r)),a=(e.get(2,1)-e.get(1,2))*n,l=(e.get(0,2)-e.get(2,0))*n;return[a,l,(e.get(1,0)-e.get(0,1))*n]}(e.R);q.push(t[0],t[1],t[2]),q.push(e.t.get(0,0),e.t.get(1,0),e.t.get(2,0))});let v=[],_=[];e.forEach((e,t)=>{e.forEach((e,r)=>{v.push([t,r,0]),_.push(e.x),v.push([t,r,1]),_.push(e.y)})});try{let r=(0,a.s)({x:v,y:_},e=>{let[r,a,l,s,u,i]=e,g=[];for(let t=0;t<T.length;t++){let r=6+6*t,a=[e[r],e[r+1],e[r+2]],l=[e[r+3],e[r+4],e[r+5]];g.push({R:o(a),t:new n.uq([[l[0]],[l[1]],[l[2]]])})}return e=>{let o=e[0],c=e[1],m=1===e[2],{R:f,t:p}=g[o],d=t[c],h=new n.uq([[d.x],[d.y],[0]]),y=f.mmul(h).add(p),w=y.get(2,0);if(1e-6>Math.abs(w))return 0;let b=y.get(0,0)/w,S=y.get(1,0)/w,E=b*b+S*S,M=E*E;return m?S*(1+u*E+i*M)*a+s:b*(1+u*E+i*M)*r+l}},{damping:1.5,initialValues:q,gradientDifference:.1,maxIterations:50,errorTolerance:.01}),l=r.parameterValues||r,[s,u,i,g,c,m]=l,f=Math.sqrt((r.parameterError||0)/_.length),p=[],d=new n.uq([[s,0,i],[0,u,g],[0,0,1]]),h=[c,m,0,0,0];return e.forEach((e,r)=>{let a=6+6*r,s=[l[a],l[a+1],l[a+2]],u=[l[a+3],l[a+4],l[a+5]],i=o(s),g=new n.uq([[u[0]],[u[1]],[u[2]]]),c=0;e.forEach((e,r)=>{var a,l;let o,s,u,m,f,p,y,w,b,S,E,M,x=t[r],A=(a=x.x,l=x.y,o=new n.uq([[a],[l],[0]]),u=(s=i.mmul(o).add(g)).get(0,0)/s.get(2,0),m=s.get(1,0)/s.get(2,0),p=(f=u*u+m*m)*f,y=h[0]||0,w=h[1]||0,b=d.get(0,0),S=d.get(1,1),E=d.get(0,2),M=d.get(1,2),{u:u*(1+y*f+w*p)*b+E,v:m*(1+y*f+w*p)*S+M}),C=(A.u-e.x)**2+(A.v-e.y)**2;c+=C});let m=c/e.length;p.push(Math.sqrt(m))}),{cameraMatrix:[s,0,i,0,u,g,0,0,1],distCoeffs:[c,m,0,0,0],rms:f,perViewErrors:p,rvecs:T.map((e,t)=>{let r=6+6*t;return[l[r],l[r+1],l[r+2]]}),tvecs:T.map((e,t)=>{let r=6+6*t;return[l[r+3],l[r+4],l[r+5]]})}}catch(e){return console.error("Calibration optimization failed:",e),{cameraMatrix:[A.fx,0,A.cx,0,A.fy,A.cy,0,0,1],distCoeffs:[0,0,0,0,0],rms:-1,perViewErrors:[],rvecs:T.map(e=>[0,0,0]),tvecs:T.map(e=>[e.t.get(0,0),e.t.get(1,0),e.t.get(2,0)])}}}(r.allImagePoints,r.objPoints,r.imageSize);self.postMessage({type:"CALIBRATE_SUCCESS",id:s,payload:u});break;default:throw Error(`Unknown message type: ${t}`)}}catch(e){self.postMessage({type:"ERROR",id:s,error:e.message})}}}},s={};function u(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}},n=!0;try{o[e](r,r.exports,u),n=!1}finally{n&&delete s[e]}return r.exports}u.m=o,u.x=()=>{var e=u.O(void 0,[927],()=>u(1333));return u.O(e)},e=[],u.O=(t,r,n,a)=>{if(r){a=a||0;for(var l=e.length;l>0&&e[l-1][2]>a;l--)e[l]=e[l-1];e[l]=[r,n,a];return}for(var o=1/0,l=0;l<e.length;l++){for(var[r,n,a]=e[l],s=!0,i=0;i<r.length;i++)(!1&a||o>=a)&&Object.keys(u.O).every(e=>u.O[e](r[i]))?r.splice(i--,1):(s=!1,a<o&&(o=a));if(s){e.splice(l--,1);var g=n();void 0!==g&&(t=g)}}return t},u.d=(e,t)=>{for(var r in t)u.o(t,r)&&!u.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},u.f={},u.e=e=>Promise.all(Object.keys(u.f).reduce((t,r)=>(u.f[r](e,t),t),[])),u.u=e=>"static/chunks/"+e+".3fd8a9bb48a63997.js",u.miniCssF=e=>{},u.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),u.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},u.tt=()=>(void 0===t&&(t={createScriptURL:e=>e},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(t=trustedTypes.createPolicy("nextjs#bundler",t))),t),u.tu=e=>u.tt().createScriptURL(e),u.p="/camera_calibrator/_next/",r={333:1},u.f.i=(e,t)=>{r[e]||importScripts(u.tu(u.p+u.u(e)))},a=(n=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(n),n.push=e=>{var[t,n,l]=e;for(var o in n)u.o(n,o)&&(u.m[o]=n[o]);for(l&&l(u);t.length;)r[t.pop()]=1;a(e)},l=u.x,u.x=()=>u.e(927).then(l),_N_E=u.x()})();