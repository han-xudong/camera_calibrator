(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1856:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>G});var a=t(5155),s=t(2115),l=t(8697),n=t(1900),o=t(6999),i=t(8459),d=t(8515),c=t(1975),x=t(6296),h=t(2484),u=t(2791),m=t(6722);let g=({images:e,onAddImages:r,onRemoveImage:t,onSelectImage:g,selectedImageId:b,onCalibrate:f,onShowResults:p,isCalibrating:w,canCalibrate:k,hasResults:j})=>{let y=(0,s.useRef)(null),[v,N]=s.useState(new Set),[C,S]=s.useState(!1),{theme:T,toggleTheme:E}=(0,m.D)();return(0,a.jsxs)("div",{className:"w-80 h-full bg-white dark:bg-neutral-900 border-r border-gray-200 dark:border-neutral-800 flex flex-col shadow-sm z-10 transition-colors duration-200",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-neutral-800 flex items-center justify-between",children:[(0,a.jsxs)("h1",{className:"text-xl font-bold flex items-center gap-2 text-black dark:text-white",children:[(0,a.jsx)(l.A,{className:"w-6 h-6"}),"Camera Calibrator"]}),(0,a.jsx)("button",{onClick:E,className:"p-1.5 rounded-lg text-gray-500 hover:bg-gray-100 dark:text-neutral-400 dark:hover:bg-neutral-800 transition-colors",title:`Switch to ${"light"===T?"dark":"light"} mode`,children:"light"===T?(0,a.jsx)(n.A,{className:"w-4 h-4"}):(0,a.jsx)(o.A,{className:"w-4 h-4"})})]}),(0,a.jsxs)("div",{className:"p-4 flex-1 overflow-hidden flex flex-col",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("h2",{className:"text-sm font-semibold text-gray-500 dark:text-neutral-400 uppercase tracking-wider",children:["Images (",e.length,")"]}),v.size>0&&(0,a.jsx)("button",{onClick:()=>{v.forEach(e=>t(e)),N(new Set)},className:"p-1 rounded text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/30 transition-colors",title:`Delete ${v.size} images`,children:(0,a.jsx)(i.A,{className:"w-4 h-4"})})]}),(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)("button",{onClick:()=>{S(!C),C&&N(new Set)},className:`p-1 rounded transition-colors ${C?"bg-black text-white dark:bg-neutral-700 dark:text-white":"text-gray-500 hover:bg-gray-100 dark:text-neutral-400 dark:hover:bg-neutral-800"}`,title:"Select multiple",children:(0,a.jsx)(d.A,{className:"w-4 h-4"})}),(0,a.jsx)("button",{onClick:()=>y.current?.click(),className:"p-1 rounded text-black hover:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 transition-colors",title:"Add images",children:(0,a.jsx)(c.A,{className:"w-4 h-4"})})]}),(0,a.jsx)("input",{type:"file",ref:y,onChange:e=>{e.target.files&&e.target.files.length>0&&r(e.target.files)},multiple:!0,accept:"image/*",className:"hidden"})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar",children:[e.map((e,r)=>(0,a.jsxs)("div",{onClick:()=>g(e.id),className:`flex items-center gap-3 p-2 rounded cursor-pointer border transition-all ${b===e.id?"bg-gray-100 border-gray-300 dark:bg-neutral-800 dark:border-neutral-600":"bg-white border-transparent hover:bg-gray-50 dark:bg-neutral-900 dark:hover:bg-neutral-800"}`,children:[(0,a.jsx)("div",{className:"flex-shrink-0 flex items-center justify-center w-5",children:C?(0,a.jsx)("input",{type:"checkbox",checked:v.has(e.id),onClick:r=>{var t;let a;r.stopPropagation(),t=e.id,(a=new Set(v)).has(t)?a.delete(t):a.add(t),N(a)},onChange:()=>{},className:"w-4 h-4 text-black rounded border-gray-300 focus:ring-black dark:text-white dark:bg-neutral-700 dark:border-neutral-600"}):(0,a.jsx)("span",{className:"text-sm font-semibold text-gray-400 dark:text-neutral-500",children:r+1})}),(0,a.jsx)("div",{className:"w-10 h-10 bg-gray-200 dark:bg-neutral-700 rounded overflow-hidden flex-shrink-0 relative",children:(0,a.jsx)("img",{src:e.url,alt:"",className:"w-full h-full object-cover"})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium truncate text-gray-700 dark:text-neutral-200",children:e.name}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:["pending"===e.status&&(0,a.jsx)("span",{className:"text-xs text-gray-400 dark:text-neutral-500",children:"Waiting..."}),"processing"===e.status&&(0,a.jsxs)("span",{className:"text-xs text-gray-600 dark:text-neutral-300 flex items-center gap-1",children:[(0,a.jsx)(x.A,{className:"w-3 h-3 animate-spin"})," Processing..."]}),"detected"===e.status&&(0,a.jsxs)("span",{className:"text-xs text-green-600 dark:text-green-400 flex items-center gap-0.5",children:[(0,a.jsx)(h.A,{className:"w-3 h-3"})," Ready"]}),"failed"===e.status&&(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("span",{className:"text-xs text-red-500 dark:text-red-400 flex items-center gap-0.5 font-medium",children:[(0,a.jsx)(u.A,{className:"w-3 h-3"})," Failed"]}),e.error&&(0,a.jsx)("span",{className:"text-[10px] text-red-400 dark:text-red-300 leading-tight mt-0.5 break-words",children:e.error})]})]})]}),(0,a.jsx)("button",{onClick:r=>{r.stopPropagation(),t(e.id)},className:"text-gray-400 hover:text-red-500 dark:text-neutral-500 dark:hover:text-red-400 p-1",children:(0,a.jsx)(i.A,{className:"w-4 h-4"})})]},e.id)),0===e.length&&(0,a.jsx)("div",{className:"text-center py-8 text-gray-400 dark:text-neutral-500 text-sm",children:"No images added."})]})]}),(0,a.jsxs)("div",{className:"p-4 border-t border-gray-200 dark:border-neutral-800 bg-gray-50 dark:bg-neutral-900/50 space-y-2",children:[j&&(0,a.jsx)("button",{onClick:p,className:"w-full py-2.5 px-4 rounded-lg font-medium border border-black text-black hover:bg-gray-100 dark:border-neutral-500 dark:text-neutral-300 dark:hover:bg-neutral-800 transition-all",children:"View Results"}),(0,a.jsx)("button",{onClick:f,disabled:!k||w,className:`w-full py-2.5 px-4 rounded-lg font-medium flex items-center justify-center gap-2 transition-all ${k&&!w?"bg-black text-white hover:bg-gray-800 shadow-md hover:shadow-lg dark:bg-neutral-700 dark:text-white dark:hover:bg-neutral-600":"bg-gray-300 text-gray-500 cursor-not-allowed dark:bg-neutral-800 dark:text-neutral-600"}`,children:w?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.A,{className:"w-4 h-4 animate-spin"})," Calibrating..."]}):(0,a.jsx)(a.Fragment,{children:"Calibrate"})})]})]})};var b=t(7243),f=t(6809),p=t(7567);let w=({url:e,corners:r,width:t,height:l})=>{let n=(0,s.useRef)(null),o=(0,s.useRef)(null);return(0,s.useEffect)(()=>{if(!n.current||!o.current)return;let e=n.current,a=e.getContext("2d");if(!a)return;let s=o.current,i=()=>{let n=s.clientWidth,o=s.clientHeight;if(0===n||0===o)return void requestAnimationFrame(i);if(e.width=n,e.height=o,e.style.width=`${n}px`,e.style.height=`${o}px`,!r||!t||!l)return void a.clearRect(0,0,e.width,e.height);let d=n/t,c=o/l;a.clearRect(0,0,e.width,e.height),r.forEach((e,t)=>{let s=e.x*d,l=e.y*c;if(a.beginPath(),a.arc(s,l,3,0,2*Math.PI),a.fillStyle=0===t?"red":"lime",a.fill(),t>0){let e=r[t-1];a.beginPath(),a.moveTo(e.x*d,e.y*c),a.lineTo(s,l),a.strokeStyle="rgba(0, 255, 0, 0.5)",a.lineWidth=1,a.stroke()}})},d=requestAnimationFrame(i);s.complete?i():s.onload=i;let c=new ResizeObserver(()=>{requestAnimationFrame(i)});return c.observe(s),()=>{c.disconnect(),cancelAnimationFrame(d),s.onload=null}},[e,r,t,l]),(0,a.jsxs)("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden",children:[(0,a.jsx)("img",{ref:o,src:e,alt:"Calibration",className:"max-w-full max-h-full object-contain shadow-lg"}),(0,a.jsx)("canvas",{ref:n,className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"})]})};var k=t(1728),j=t(9424),y=t(8408),v=t(2539),N=t(9656),C=t(8021),S=t(9539),T=t(7389);let E=({errors:e,onSelect:r,selectedIndex:t=-1})=>{let{theme:s}=(0,m.D)(),l="dark"===s,n=l?"#9ca3af":"#666",o=l?"#374151":"#e5e7eb",i=l?"#171717":"#ffffff",d=l?"#262626":"#e5e7eb",c=l?"#d4d4d4":"#111827",x=e.map((e,r)=>({name:`${r+1}`,error:e,index:r})),h=e.reduce((e,r)=>e+r,0)/e.length;return(0,a.jsxs)("div",{className:"w-full h-full p-4 flex flex-col",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100",children:["Mean Reprojection Error: ",h.toFixed(4)," px"]}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(k.u,{width:"100%",height:"100%",children:(0,a.jsxs)(j.E,{data:x,margin:{top:10,right:10,left:0,bottom:20},children:[(0,a.jsx)(y.d,{strokeDasharray:"3 3",stroke:o}),(0,a.jsx)(v.W,{dataKey:"name",label:{value:"Image Index",position:"insideBottom",offset:-10,fill:n},tick:{fill:n},stroke:o}),(0,a.jsx)(N.h,{label:{value:"Error (pixels)",angle:-90,position:"insideLeft",offset:10,style:{textAnchor:"middle"},fill:n},tick:{fill:n},stroke:o}),(0,a.jsx)(C.m,{cursor:{fill:l?"rgba(255,255,255,0.05)":"transparent"},content:({active:e,payload:r})=>{if(e&&r&&r.length){let e=r[0].payload;return(0,a.jsxs)("div",{className:"p-2 border shadow-md rounded text-sm",style:{backgroundColor:i,borderColor:d,color:c},children:[(0,a.jsxs)("p",{className:"font-semibold",children:["Image ",e.index+1]}),(0,a.jsxs)("p",{children:["Error: ",Number(e.error).toFixed(4)," px"]})]})}return null}}),(0,a.jsx)(S.yP,{dataKey:"error",name:"Mean Error",onClick:e=>{e&&e.payload&&"number"==typeof e.payload.index?r?.(e.payload.index):e&&"number"==typeof e.index&&r?.(e.index)},cursor:"pointer",children:x.map((e,r)=>(0,a.jsx)(T.f,{fill:r===t?"#ea580c":l?"#525252":"#9ca3af"},`cell-${r}`))})]})})})]})};var P=t(6275),A=t(4170),I=t(6824),q=t(7575),F=t(4350),z=t(4406),D=t(7814),$=t(5269);let _=({color:e,label:r,scale:t=1,showFrustum:l=!0,isSelected:n=!1,onClick:o})=>{let i=15*t,d=10*t,c=25*t,x=(0,s.useMemo)(()=>{let e=[new $.Pq0(0,0,0),new $.Pq0(-i,-d,c),new $.Pq0(0,0,0),new $.Pq0(i,-d,c),new $.Pq0(0,0,0),new $.Pq0(i,d,c),new $.Pq0(0,0,0),new $.Pq0(-i,d,c),new $.Pq0(-i,-d,c),new $.Pq0(i,-d,c),new $.Pq0(i,-d,c),new $.Pq0(i,d,c),new $.Pq0(i,d,c),new $.Pq0(-i,d,c),new $.Pq0(-i,d,c),new $.Pq0(-i,-d,c),new $.Pq0(-i/2,-d,c),new $.Pq0(0,-d-5*t,c),new $.Pq0(0,-d-5*t,c),new $.Pq0(i/2,-d,c)];return new $.LoY().setFromPoints(e)},[t,i,d,c]),h=(0,s.useMemo)(()=>{let e=new Float32Array([0,0,0,-i,-d,c,i,-d,c,i,d,c,-i,d,c]),r=new $.LoY;return r.setAttribute("position",new $.THS(e,3)),r.setIndex([0,1,2,0,2,3,0,3,4,0,4,1,1,4,3,1,3,2]),r.computeVertexNormals(),r},[t,i,d,c]),u=n?"#ea580c":e;return(0,a.jsxs)("group",{onClick:e=>{e.stopPropagation(),o?.()},children:[l&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("mesh",{geometry:h,children:(0,a.jsx)("meshBasicMaterial",{color:u,transparent:!0,opacity:n?.4:.15,side:$.$EB,depthWrite:!1})}),(0,a.jsx)("lineSegments",{geometry:x,children:(0,a.jsx)("lineBasicMaterial",{color:u,linewidth:2})})]}),(0,a.jsxs)("mesh",{position:[0,0,0],children:[(0,a.jsx)("sphereGeometry",{args:[2*t,16,16]}),(0,a.jsx)("meshBasicMaterial",{color:u})]}),(0,a.jsx)(A.Q,{position:[0,-15*t,0],follow:!0,lockX:!1,lockY:!1,lockZ:!1,children:(0,a.jsx)(I.E,{fontSize:4*t,color:n?"#ea580c":u,anchorX:"center",anchorY:"middle",fontWeight:n?"bold":"normal",children:r})})]})},R=({width:e,height:r,color:t,label:s,isSelected:l=!1,onClick:n})=>{let o=l?"#ea580c":t;return(0,a.jsxs)("group",{onClick:e=>{e.stopPropagation(),n?.()},children:[(0,a.jsxs)("mesh",{children:[(0,a.jsx)("boxGeometry",{args:[e,r,2]}),(0,a.jsx)("meshStandardMaterial",{color:o,transparent:!0,opacity:l?.8:.6})]}),(0,a.jsxs)("mesh",{position:[0,0,1.1],children:[(0,a.jsx)("planeGeometry",{args:[e,r]}),(0,a.jsx)("meshBasicMaterial",{color:o,wireframe:!0})]}),s&&(0,a.jsx)(A.Q,{position:[-e/2,-r/2-10,0],follow:!0,children:(0,a.jsx)(I.E,{fontSize:6,color:o,fontWeight:l?"bold":"normal",anchorX:"center",anchorY:"middle",children:s})}),(0,a.jsx)("axesHelper",{args:[20],position:[-e/2,-r/2,2]})]})},M=({rvecs:e,tvecs:r,boardSize:t={width:200,height:150},onSelect:l,selectedIndex:n=-1})=>{let[o,i]=(0,s.useState)("pattern-centric"),d=["#FF4136","#2ECC40","#0074D9","#FF851B","#B10DC9","#FFDC00","#39CCCC","#F012BE","#01FF70","#85144b"],c=5/(t.squareSize||1),x=t.width*c,h=t.height*c,u=(0,s.useMemo)(()=>e.map((e,t)=>{let a=new $.Pq0(r[t][0]*c,r[t][1]*c,r[t][2]*c),s=Math.sqrt(e[0]**2+e[1]**2+e[2]**2),l=s<1e-6?new $.Pq0(1,0,0):new $.Pq0(e[0]/s,e[1]/s,e[2]/s),n=new $.PTz().setFromAxisAngle(l,s);new $.kn4().compose(a,n,new $.Pq0(1,1,1)).invert();let o=new $.kn4().makeRotationFromQuaternion(n),i=new $.kn4().copy(o).setPosition(a);return{camToWorld:i.clone().invert(),boardToCamMatrix:i}}),[e,r,c]),m=Math.max(x,h)/32;return(0,a.jsxs)("div",{className:"w-full h-full bg-white dark:bg-neutral-900 relative flex flex-col transition-colors duration-200",children:[(0,a.jsxs)("div",{className:"absolute top-4 left-4 z-10 bg-white/90 dark:bg-neutral-800/90 rounded shadow p-1 flex space-x-1",children:[(0,a.jsx)("button",{onClick:()=>i("pattern-centric"),className:`px-3 py-1 text-xs font-medium rounded transition-colors ${"pattern-centric"===o?"bg-black text-white dark:bg-neutral-700 dark:text-white":"text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-neutral-700"}`,children:"Pattern Centric"}),(0,a.jsx)("button",{onClick:()=>i("camera-centric"),className:`px-3 py-1 text-xs font-medium rounded transition-colors ${"camera-centric"===o?"bg-black text-white dark:bg-neutral-700 dark:text-white":"text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-neutral-700"}`,children:"Camera Centric"})]}),(0,a.jsxs)(P.Hl,{camera:{up:[0,0,1],fov:45},children:[(0,a.jsx)("ambientLight",{intensity:.8}),(0,a.jsx)("directionalLight",{position:[100,100,200],intensity:1}),(0,a.jsx)(q.N,{makeDefault:!0}),(0,a.jsx)(F.z,{alignment:"bottom-right",margin:[80,80],children:(0,a.jsx)(z.t,{axisColors:["#EF4444","#22C55E","#3B82F6"],labelColor:"black"})}),(0,a.jsx)(D.c,{fit:!0,clip:!0,observe:!0,margin:1.2,children:"pattern-centric"===o?(0,a.jsxs)("group",{rotation:[0,0,0],children:[(0,a.jsx)("group",{position:[x/2,h/2,0],children:(0,a.jsx)(R,{width:x,height:h,color:"#aaaaaa",label:"Fixed Pattern"})}),u.map((e,r)=>(0,a.jsx)("group",{matrix:e.camToWorld,matrixAutoUpdate:!1,children:(0,a.jsx)(_,{color:d[r%d.length],label:`${r+1}`,isSelected:r===n,onClick:()=>l?.(r),scale:m})},r))]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("group",{position:[0,0,0],rotation:[0,0,0],children:(0,a.jsx)(_,{color:"#0074D9",label:"Fixed Camera",scale:m})}),u.map((e,r)=>(0,a.jsx)("group",{matrix:e.boardToCamMatrix,matrixAutoUpdate:!1,children:(0,a.jsx)("group",{position:[x/2,h/2,0],children:(0,a.jsx)(R,{width:x,height:h,color:d[r%d.length],label:`${r+1}`,isSelected:r===n,onClick:()=>l?.(r)})})},r))]})})]})]})},W=({activeTab:e,setActiveTab:r,selectedImage:t,calibrationResult:s,reprojectionErrors:l,boardConfig:n,onSelectCalibrationImage:o,selectedIndex:i=-1})=>s?(0,a.jsxs)("div",{className:"flex-1 flex h-full overflow-hidden bg-white dark:bg-neutral-950 transition-colors",children:[(0,a.jsx)("div",{className:"w-1/2 flex flex-col border-r border-gray-200 dark:border-neutral-800",children:(0,a.jsx)("div",{className:"flex-1 bg-gray-100 dark:bg-neutral-900/50 p-4 relative overflow-hidden flex flex-col",children:t?(0,a.jsx)(w,{url:t.url,corners:t.corners,width:t.width,height:t.height}):(0,a.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 dark:text-neutral-500",children:[(0,a.jsx)(b.A,{className:"w-12 h-12 mb-2 opacity-50"}),(0,a.jsx)("p",{children:"Select an image"})]})})}),(0,a.jsxs)("div",{className:"w-1/2 flex flex-col bg-white dark:bg-neutral-900 border-l border-gray-200 dark:border-neutral-800",children:[(0,a.jsxs)("div",{className:"h-1/2 flex flex-col border-b border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-900",children:[(0,a.jsxs)("div",{className:"border-b border-gray-200 dark:border-neutral-800 px-4 py-3 bg-white dark:bg-neutral-900 shadow-sm z-10 flex items-center gap-2",children:[(0,a.jsx)(f.A,{className:"w-5 h-5 text-black dark:text-neutral-400"}),(0,a.jsx)("span",{className:"font-semibold text-gray-700 dark:text-neutral-200 text-sm",children:"Reprojection Errors"})]}),(0,a.jsx)("div",{className:"flex-1 relative p-2 bg-white dark:bg-neutral-900",children:(0,a.jsx)(E,{errors:l||[],onSelect:o,selectedIndex:i})})]}),(0,a.jsxs)("div",{className:"h-1/2 flex flex-col bg-white dark:bg-neutral-900",children:[(0,a.jsxs)("div",{className:"border-b border-gray-200 dark:border-neutral-800 px-4 py-3 bg-white dark:bg-neutral-900 shadow-sm z-10 flex items-center gap-2",children:[(0,a.jsx)(p.A,{className:"w-5 h-5 text-black dark:text-neutral-400"}),(0,a.jsx)("span",{className:"font-semibold text-gray-700 dark:text-neutral-200 text-sm",children:"Extrinsics View"})]}),(0,a.jsx)("div",{className:"flex-1 relative bg-white dark:bg-neutral-900",children:(0,a.jsx)(M,{rvecs:s?.rvecs||[],tvecs:s?.tvecs||[],boardSize:n,onSelect:o,selectedIndex:i})})]})]})]}):(0,a.jsx)("div",{className:"flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-neutral-950 transition-colors",children:(0,a.jsx)("div",{className:"flex-1 bg-gray-100 dark:bg-neutral-900/50 p-4 relative overflow-hidden flex flex-col",children:t?(0,a.jsx)(w,{url:t.url,corners:t.corners,width:t.width,height:t.height}):(0,a.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 dark:text-neutral-500",children:[(0,a.jsx)(b.A,{className:"w-12 h-12 mb-2 opacity-50"}),(0,a.jsx)("p",{children:"Select an image to view details"})]})})});var L=t(3210),O=t(6962);let B=({isOpen:e,onClose:r,result:t})=>{if(!e||!t)return null;console.log("[ResultsModal] Received result:",t);let s=t.cameraMatrix||t.camera_matrix,l=t.distCoeffs||t.dist_coeffs,n=t.rms,o=(e,r,t)=>{if(!e)return"[]";let a=Array.isArray(e)&&e.length>0&&Array.isArray(e[0]),s="[\n";for(let l=0;l<r;l++){s+="  [";for(let n=0;n<t;n++){let o=0;a?1===r?o=Array.isArray(e[0])?e[0][n]||0:e[n]||0:e[l]&&(o=e[l][n]||0):o=1===r?e[n]||0:e[l*t+n]||0,s+=(o||0).toFixed(6)+(n<t-1?", ":"")}s+="]"+(l<r-1?",\n":"\n")}return s+"]"};return(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-neutral-900 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col transition-colors",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b dark:border-neutral-800",children:[(0,a.jsx)("h2",{className:"text-xl font-bold dark:text-white",children:"Calibration Results"}),(0,a.jsx)("button",{onClick:r,className:"p-1 hover:bg-gray-100 dark:hover:bg-neutral-800 rounded dark:text-gray-400",children:(0,a.jsx)(L.A,{className:"w-5 h-5"})})]}),(0,a.jsxs)("div",{className:"p-6 space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2",children:"RMS Error"}),(0,a.jsxs)("p",{className:"text-2xl font-mono text-black dark:text-neutral-200",children:[n.toFixed(5)," px"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2",children:"Camera Matrix (Intrinsics)"}),(0,a.jsx)("pre",{className:"bg-gray-50 dark:bg-neutral-800 p-4 rounded border dark:border-neutral-700 text-sm font-mono overflow-x-auto dark:text-gray-300",children:o(s,3,3)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2",children:"Distortion Coefficients"}),(0,a.jsx)("pre",{className:"bg-gray-50 dark:bg-neutral-800 p-4 rounded border dark:border-neutral-700 text-sm font-mono overflow-x-auto dark:text-gray-300",children:o(l,1,5)}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:"Order: k1, k2, p1, p2, k3, ..."})]})]}),(0,a.jsx)("div",{className:"p-4 border-t dark:border-neutral-800 bg-gray-50 dark:bg-neutral-800/50 flex justify-end gap-2",children:(0,a.jsxs)("button",{onClick:()=>{let e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(e),a=document.createElement("a");a.href=r,a.download="camera_calibration.json",a.click(),URL.revokeObjectURL(r)},className:"bg-black text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-800 dark:bg-neutral-700 dark:hover:bg-neutral-600 dark:text-white",children:[(0,a.jsx)(O.A,{className:"w-4 h-4"})," Export JSON"]})})]})})};var U=t(9363);let X=({isOpen:e,onClose:r,onConfirm:t,initialSettings:l})=>{let[n,o]=s.useState({boardType:"chessboard",rows:0,cols:0,squareSize:25,tagFamily:"tag36h11",...l});return e?(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-md overflow-hidden transition-colors",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-100 dark:border-neutral-800",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2",children:[(0,a.jsx)(U.A,{className:"w-5 h-5 text-black dark:text-neutral-400"}),"Calibration Settings"]}),(0,a.jsx)("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:(0,a.jsx)(L.A,{className:"w-5 h-5"})})]}),(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),t(n)},className:"p-6 space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Calibration Board Type"}),(0,a.jsx)("div",{className:"grid grid-cols-3 gap-2",children:["chessboard","charuco","aprilgrid"].map(e=>(0,a.jsx)("button",{type:"button",onClick:()=>o({...n,boardType:e}),className:`px-3 py-2 text-sm font-medium rounded-lg capitalize transition-all ${n.boardType===e?"bg-black text-white shadow-md dark:bg-neutral-700 dark:text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-neutral-800 dark:text-gray-400 dark:hover:bg-neutral-700"}`,children:e},e))})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Square Size (mm)"}),(0,a.jsx)("input",{type:"number",min:"1",step:"0.1",value:n.squareSize,onChange:e=>o({...n,squareSize:parseFloat(e.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 dark:border-neutral-700 rounded-lg focus:ring-2 focus:ring-black focus:border-black dark:bg-neutral-800 dark:text-white dark:focus:ring-neutral-600 dark:focus:border-neutral-600"})]}),"charuco"===n.boardType&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Marker Size (mm)"}),(0,a.jsx)("input",{type:"number",min:"1",step:"0.1",value:n.markerSize||.6*n.squareSize,onChange:e=>o({...n,markerSize:parseFloat(e.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 dark:border-neutral-700 rounded-lg focus:ring-2 focus:ring-black focus:border-black dark:bg-neutral-800 dark:text-white dark:focus:ring-neutral-600 dark:focus:border-neutral-600"})]})]}),"aprilgrid"===n.boardType&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Tag Family"}),(0,a.jsxs)("select",{value:n.tagFamily,onChange:e=>o({...n,tagFamily:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-neutral-700 rounded-lg focus:ring-2 focus:ring-black focus:border-black bg-white dark:bg-neutral-800 dark:text-white dark:focus:ring-neutral-600 dark:focus:border-neutral-600",children:[(0,a.jsx)("option",{value:"tag36h11",children:"Tag36h11 (Standard)"}),(0,a.jsx)("option",{value:"tagStandard41h12",children:"TagStandard41h12"}),(0,a.jsx)("option",{value:"tag25h9",children:"Tag25h9"}),(0,a.jsx)("option",{value:"tag16h5",children:"Tag16h5"})]})]}),"charuco"===n.boardType&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Dictionary"}),(0,a.jsxs)("select",{value:n.dictionary||"DICT_6X6_250",onChange:e=>o({...n,dictionary:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 dark:border-neutral-700 rounded-lg focus:ring-2 focus:ring-black focus:border-black bg-white dark:bg-neutral-800 dark:text-white dark:focus:ring-neutral-600 dark:focus:border-neutral-600",children:[(0,a.jsx)("option",{value:"DICT_4X4_50",children:"DICT_4X4_50"}),(0,a.jsx)("option",{value:"DICT_5X5_100",children:"DICT_5X5_100"}),(0,a.jsx)("option",{value:"DICT_6X6_250",children:"DICT_6X6_250"}),(0,a.jsx)("option",{value:"DICT_7X7_1000",children:"DICT_7X7_1000"})]})]}),(0,a.jsxs)("div",{className:"pt-4 flex items-center justify-end gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:r,className:"px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors dark:text-gray-300 dark:hover:bg-neutral-800",children:"Cancel"}),(0,a.jsx)("button",{type:"submit",className:"px-4 py-2 text-sm font-medium text-white bg-black hover:bg-gray-800 rounded-lg shadow-md transition-colors dark:bg-neutral-700 dark:hover:bg-neutral-600",children:"Confirm & Detect"})]})]})]})}):null};var Y=t(8103);function G(){let{isReady:e,initError:r,logs:t,detect:l,calibrate:n}=(0,Y.y)(),[o,i]=(0,s.useState)([]),[d,c]=(0,s.useState)(null),[x,h]=(0,s.useState)("image"),[u,m]=(0,s.useState)(!1),[b,f]=(0,s.useState)({boardType:"chessboard",rows:0,cols:0,squareSize:25,tagFamily:"tag36h11"}),[p,w]=(0,s.useState)(null),[k,j]=(0,s.useState)(!1),[y,v]=(0,s.useState)(!1),[N,C]=(0,s.useState)([]),S=o.find(e=>e.id===d);if(!e)return r?(0,a.jsx)("div",{className:"flex items-center justify-center h-screen w-screen bg-gray-50 p-4",children:(0,a.jsxs)("div",{className:"text-center max-w-md bg-white p-8 rounded-lg shadow-lg",children:[(0,a.jsx)("div",{className:"text-red-500 mb-4",children:(0,a.jsx)("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Initialization Error"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4 break-all",children:r}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors",children:"Retry"})]})}):(0,a.jsx)("div",{className:"flex items-center justify-center h-screen w-screen bg-gray-50",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-700",children:"Loading Detector..."}),(0,a.jsx)("p",{className:"text-gray-500 text-sm mt-2",children:"This may take a few seconds."}),(0,a.jsx)("p",{className:"text-xs text-gray-400 mt-4 max-w-xs mx-auto",children:"If this takes too long, please check your network connection or try refreshing."}),t&&t.length>0&&(0,a.jsx)("div",{className:"mt-4 p-2 bg-gray-100 rounded text-xs font-mono text-left max-w-sm mx-auto overflow-hidden",children:t.map((e,r)=>(0,a.jsx)("div",{className:"truncate",children:e},r))})]})});let T=async e=>{let r=Array.from(e).map(e=>({id:crypto.randomUUID(),url:URL.createObjectURL(e),name:e.name,status:"pending",file:e}));i(e=>[...e,...r]),m(!0)},E=async e=>{f(e),m(!1);let r=o.map(e=>e.id),t={...e};for(let e of r){let r=o.find(r=>r.id===e);if(r){let e=await P(r.id,r.url,t);0===t.rows&&e&&e.found&&e.rows&&e.cols&&(console.log(`Auto-detected board size: ${e.rows}x${e.cols}. Applying to subsequent images.`),t={...t,rows:e.rows,cols:e.cols},f(r=>({...r,rows:e.rows,cols:e.cols})))}}},P=async(e,r,t)=>{i(r=>r.map(r=>r.id===e?{...r,status:"processing"}:r));try{let a=await new Promise((e,t)=>{let a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{let r=document.createElement("canvas");r.width=a.width,r.height=a.height;let s=r.getContext("2d");s?(s.drawImage(a,0,0),e(s.getImageData(0,0,a.width,a.height))):t(Error("Failed to get canvas context"))},a.onerror=e=>t(e),a.src=r});i(r=>r.map(r=>r.id===e?{...r,width:a.width,height:a.height}:r)),console.log(`Processing image ${e} with settings:`,t);let s=await l(a,t);return console.log(`Detection result for ${e}:`,s),s.found?i(r=>r.map(r=>r.id===e?{...r,status:"detected",detections:s.detections,corners:s.corners||s.detections.flatMap(e=>e.corners),boardSize:s.rows&&s.cols?{rows:s.rows,cols:s.cols}:void 0,error:void 0}:r)):i(r=>r.map(r=>r.id===e?{...r,status:"failed",error:s.error||"Detection failed"}:r)),s}catch(r){return console.error(r),i(t=>t.map(t=>t.id===e?{...t,status:"failed",error:r.message}:t)),null}},A=async()=>{let e=o.filter(e=>"detected"===e.status);if(e.length<3)return void alert("Need at least 3 images with detected corners to calibrate.");let r=e.map(e=>e.corners?.length||0),t=new Map;r.forEach(e=>t.set(e,(t.get(e)||0)+1));let a=0,s=0;if(t.forEach((e,r)=>{e>s&&r>0&&(s=e,a=r)}),0===a)return void alert("No valid corners detected.");let l=e.filter(e=>(e.corners?.length||0)===a);if(l.length<3)return void alert(`Found ${l.length} images with ${a} corners, but need at least 3. (Discarded ${e.length-l.length} images with mismatched counts)`);C(l.map(e=>e.id)),l.length<e.length&&console.warn(`Discarding ${e.length-l.length} images due to mismatched corner counts.`),j(!0);try{let e=[],r=[],t=[];if("chessboard"===b.boardType){let e=b.rows,r=b.cols;if(0===e||0===r){let t=l.map(e=>e.boardSize).filter(e=>e);if(t.length>0){let s=t.find(e=>e&&e.rows*e.cols===a);s?(e=s.rows,r=s.cols):(e=t[0].rows,r=t[0].cols),f(t=>({...t,rows:e,cols:r}))}else throw Error("Could not auto-detect board dimensions. Please ensure detection was successful.")}if(e*r!==a&&((e-1)*(r-1)===a?(e-=1,r-=1):r*e!==a&&(r-1)*(e-1)===a&&(e=b.cols-1,r=b.rows-1)),e*r!==a)throw Error(`Detected ${a} corners, but expect ${e}x${r} (${e*r}). Please check your settings.`);for(let a=0;a<e;a++)for(let e=0;e<r;e++)t.push({x:e*b.squareSize,y:a*b.squareSize,z:0})}else if("aprilgrid"===b.boardType){let e=b.squareSize/2;t=[{x:-e,y:e},{x:e,y:e},{x:e,y:-e},{x:-e,y:-e}]}l.forEach(r=>{if("aprilgrid"===b.boardType){if(r.detections&&r.detections.length>0){let t=r.detections[0];e.push(t.corners)}}else r.corners&&e.push(r.corners)}),r.push(...t);let s={width:l[0].width,height:l[0].height},o=await n(e,r,s);w(o),v(!0)}catch(e){alert("Calibration failed: "+e.message)}finally{j(!1)}},I=o.length>0&&o.every(e=>"detected"===e.status||"failed"===e.status)&&o.filter(e=>"detected"===e.status).length>=3;return(0,a.jsxs)("div",{className:"flex h-screen w-screen overflow-hidden",children:[(0,a.jsx)(g,{images:o,onAddImages:T,onRemoveImage:e=>{i(r=>r.filter(r=>r.id!==e)),d===e&&c(null)},onSelectImage:c,selectedImageId:d,onCalibrate:A,onShowResults:()=>v(!0),isCalibrating:k,canCalibrate:I,hasResults:!!p}),(0,a.jsx)(W,{activeTab:x,setActiveTab:h,selectedImage:S,calibrationResult:p,reprojectionErrors:p?.perViewErrors,boardConfig:{width:(b.cols-1)*b.squareSize,height:(b.rows-1)*b.squareSize,squareSize:b.squareSize},onSelectCalibrationImage:e=>{e>=0&&e<N.length&&c(N[e])},selectedIndex:d?N.indexOf(d):-1}),(0,a.jsx)(X,{isOpen:u,onClose:()=>m(!1),onConfirm:E,initialSettings:b}),(0,a.jsx)(B,{isOpen:y,onClose:()=>v(!1),result:p})]})}},4294:(e,r,t)=>{Promise.resolve().then(t.bind(t,1856))},6722:(e,r,t)=>{"use strict";t.d(r,{D:()=>o,ThemeProvider:()=>n});var a=t(5155),s=t(2115);let l=(0,s.createContext)(void 0);function n({children:e}){let[r,t]=(0,s.useState)("light");return(0,s.useEffect)(()=>{let e=localStorage.getItem("theme");e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches&&t("dark")},[]),(0,s.useEffect)(()=>{let e=window.document.documentElement;"dark"===r?e.classList.add("dark"):e.classList.remove("dark"),localStorage.setItem("theme",r)},[r]),(0,a.jsx)(l.Provider,{value:{theme:r,toggleTheme:()=>{t(e=>"light"===e?"dark":"light")}},children:e})}function o(){let e=(0,s.useContext)(l);if(void 0===e)throw Error("useTheme must be used within a ThemeProvider");return e}},8103:(e,r,t)=>{"use strict";t.d(r,{AprilTagProvider:()=>n,y:()=>o});var a=t(5155),s=t(2115);let l=(0,s.createContext)(null),n=({children:e})=>{let[r,n]=(0,s.useState)(!1),[o,i]=(0,s.useState)(null),[d,c]=(0,s.useState)([]),x=(0,s.useRef)(null),h=(0,s.useRef)(new Map),u=e=>{console.log("[AprilTagContext]",e),c(r=>[...r.slice(-4),e])};(0,s.useEffect)(()=>{console.log("Creating worker...");let e=new Worker(t.tu(new URL(t.p+t.u(98),t.b)));x.current=e,e.onmessage=e=>{let{type:r,id:t,payload:a,error:s,message:l}=e.data;if("LOG"===r)return void u(`[Worker] ${l}`);if("INIT_SUCCESS"===r){u("Worker Init Success"),n(!0);let e=h.current.get(t);e&&e.resolve()}else if(s){u(`Worker Error: ${s}`),console.error("Worker Error:",s),"ERROR"===r&&t&&t.startsWith("init_")&&i(s);let e=h.current.get(t);e&&e.reject(Error(s))}else{let e=h.current.get(t);e&&(e.resolve(a),h.current.delete(t))}},e.onerror=e=>{u(`Worker script error: ${JSON.stringify(e)}`),console.error("Worker script error:",e),i("Failed to load worker script.")};let a=setTimeout(()=>{r||u("Initialization timed out (15s)")},15e3),s=`${window.location.origin}/camera_calibrator/`,l=`${s}apriltag.js`;console.log(`Initializing worker with publicBaseUrl: ${s}`);let o="init_"+Date.now();return h.current.set(o,{resolve:()=>{},reject:e=>i(e.message)}),e.postMessage({type:"INIT",id:o,payload:{url:l,baseUrl:s}}),()=>{clearTimeout(a),e.terminate()}},[]);let m=(e,r)=>new Promise((t,a)=>{if(!x.current)return void a(Error("Worker not initialized"));let s=e+"_"+Date.now()+"_"+Math.random(),l=setTimeout(()=>{h.current.has(s)&&(h.current.delete(s),a(Error(`Worker timed out for ${e}`)))},6e4);h.current.set(s,{resolve:e=>{clearTimeout(l),t(e)},reject:e=>{clearTimeout(l),a(e)}}),x.current.postMessage({type:e,id:s,payload:r})}),g=async(e,t)=>{try{if(r&&!o)return await m("DETECT",{imageData:e,settings:t});throw console.warn("Worker not ready or failed init, skipping directly to API fallback."),Error("Worker not ready")}catch(s){console.warn("Worker detection failed or not ready, trying API fallback...",s);let r=document.createElement("canvas");r.width=e.width,r.height=e.height;let a=r.getContext("2d");if(!a)throw Error("Could not create canvas context");return a.putImageData(e,0,0),new Promise((e,a)=>{r.toBlob(async r=>{if(!r)return void a(Error("Failed to create blob from image"));let s=new FormData;s.append("image",r,"image.jpg"),s.append("rows",t.rows.toString()),s.append("cols",t.cols.toString());try{let r=await fetch("/camera_calibrator/api/detect",{method:"POST",body:s});if(!r.ok){if(404===r.status){let r=await fetch("/api/detect",{method:"POST",body:s});if(!r.ok)throw Error(await r.text());let t=await r.json();e({found:t.success,corners:t.corners,rows:t.rows,cols:t.cols,error:t.error});return}throw Error(await r.text())}let t=await r.json();e({found:t.success,corners:t.corners,rows:t.rows,cols:t.cols,error:t.error})}catch(e){a(e)}},"image/jpeg")})}},b=async(e,r,t)=>m("CALIBRATE",{allImagePoints:e,objPoints:r,imageSize:t});return(0,a.jsx)(l.Provider,{value:{isReady:r,initError:o,logs:d,detect:g,calibrate:b},children:e})},o=()=>{let e=(0,s.useContext)(l);if(!e)throw Error("useAprilTag must be used within an AprilTagProvider");return e}}},e=>{e.O(0,[367,831,683,413,826,441,794,358],()=>e(e.s=4294)),_N_E=e.O()}]);