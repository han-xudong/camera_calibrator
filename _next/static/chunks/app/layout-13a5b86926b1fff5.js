(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{2335:(e,t,r)=>{Promise.resolve().then(r.bind(r,4007)),Promise.resolve().then(r.bind(r,6722)),Promise.resolve().then(r.t.bind(r,6872,23))},4007:(e,t,r)=>{"use strict";r.d(t,{C:()=>c,CalibrationProvider:()=>l});var o=r(5155),a=r(2115),n=r(1463);let i=(0,a.createContext)(null),l=({children:e})=>{let[t,l]=(0,a.useState)(!1),[c,s]=(0,a.useState)(null),[d,u]=(0,a.useState)("Initializing..."),[h,m]=(0,a.useState)(!1),f=(0,a.useRef)(null),g=(0,a.useRef)(new Map);(0,a.useEffect)(()=>{(async()=>{let e=n.env.NEXT_PUBLIC_BACKEND_API_URL||"https://han-xudong-opencv-camera-calibration.hf.space";if(console.log("[Context] Configured Backend URL:",e),e)try{let t=new AbortController,r=setTimeout(()=>t.abort(),2e3);await fetch(e,{signal:t.signal}),clearTimeout(r)}catch(e){console.log("Backend might be sleeping or unreachable")}})()},[]),(0,a.useEffect)(()=>{let e=new Worker(r.tu(new URL(r.p+r.u(333),r.b)));f.current=e,e.onmessage=e=>{let{type:r,id:o,payload:a,error:n,message:i}=e.data;if("INIT_SUCCESS"===r){console.log("Worker Init Success"),l(!0),u(null);let e=g.current.get(o);e&&e.resolve()}else if("PROGRESS"===r)t||u(i);else if(n){console.error("Worker Error:",n),"ERROR"===r&&o&&o.startsWith("init_")&&(s(n),u(null));let e=g.current.get(o);e&&e.reject(Error(n))}else{let e=g.current.get(o);e&&(e.resolve(a),g.current.delete(o))}},e.onerror=e=>{console.error("Worker script error:",e),s("Failed to load worker script.")};let o="init_"+Date.now();g.current.set(o,{resolve:()=>{},reject:e=>s(e.message)});let a="/camera_calibrator".replace(/\/$/,""),n=`${window.location.origin}${a}/apriltag.js`;console.log("[Context] Initializing worker with AprilTag URL:",n),e.postMessage({type:"INIT",id:o,payload:{url:n}});let i=setTimeout(()=>{l(e=>e||(console.warn("[Context] Worker init timed out or took too long, forcing UI ready state (features might still be loading)"),u(null),!0))},15e3);return()=>{clearTimeout(i),e.terminate()}},[]);let p=(e,t)=>new Promise((r,o)=>{if(!f.current)return void o(Error("Worker not initialized"));let a=e+"_"+Date.now()+"_"+Math.random(),n=setTimeout(()=>{g.current.has(a)&&(g.current.delete(a),o(Error(`Worker timed out for ${e}`)))},6e4);g.current.set(a,{resolve:e=>{clearTimeout(n),r(e)},reject:e=>{clearTimeout(n),o(e)}}),f.current.postMessage({type:e,id:a,payload:t})}),w=async(e,t)=>{let r=n.env.NEXT_PUBLIC_BACKEND_API_URL||"https://han-xudong-opencv-camera-calibration.hf.space";if(r&&("checkerboard"===t.boardType||"chessboard"===t.boardType))try{return await b(e,t,r)}catch(e){console.warn("Remote Backend detection failed, falling back to worker:",e)}if("checkerboard"===t.boardType||t.boardType,r&&("checkerboard"===t.boardType||"chessboard"===t.boardType))throw Error("Remote Backend is unreachable. Please check your network or try again later.");return p("DETECT",{imageData:e,settings:t})},b=async(e,t,r)=>{{let o=document.createElement("canvas");o.width=e.width,o.height=e.height;let a=o.getContext("2d");if(!a)throw Error("Could not create canvas context");a.putImageData(e,0,0);let n=await new Promise(e=>o.toBlob(e,"image/jpeg",.95));if(!n)throw Error("Failed to create image blob");let i=new FormData;i.append("image",n,"upload.jpg"),i.append("rows",String(t.rows||0)),i.append("cols",String(t.cols||0));let l=r?`${r}/detect`:"/api/detect",c=await fetch(l,{method:"POST",body:i}),s=await c.json();if(void 0!==s.success&&(s.found=s.success),s.camera_matrix&&(s.cameraMatrix=s.camera_matrix),s.dist_coeffs&&(s.distCoeffs=s.dist_coeffs),!c.ok)throw Error(s.error||"Backend detection failed");return s}},k=async(e,t,r)=>{let o=n.env.NEXT_PUBLIC_BACKEND_API_URL||"https://han-xudong-opencv-camera-calibration.hf.space";if(o)try{return console.log("[Context] Attempting Remote Backend Calibration..."),await C(e,t,r,o)}catch(e){console.warn("[Context] Remote Backend calibration failed, falling back to worker:",e)}return p("CALIBRATE",{allImagePoints:e,objPoints:t,imageSize:r})},C=async(e,t,r,o)=>{{let a=o?`${o}/calibrate`:"/api/calibrate_compute",n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({allImagePoints:e,objPoints:t,imageSize:r})}),i=await n.json();if(!n.ok)throw Error(i.error||"Backend calibration failed");return i}};return(0,o.jsx)(i.Provider,{value:{isReady:t,initError:c,loadingStatus:d,detect:w,calibrate:k},children:e})},c=()=>{let e=(0,a.useContext)(i);if(!e)throw Error("useCalibration must be used within an CalibrationProvider");return e}},6722:(e,t,r)=>{"use strict";r.d(t,{D:()=>l,ThemeProvider:()=>i});var o=r(5155),a=r(2115);let n=(0,a.createContext)(void 0);function i({children:e}){let[t,r]=(0,a.useState)("light");return(0,a.useEffect)(()=>{let e=localStorage.getItem("theme");e?r(e):window.matchMedia("(prefers-color-scheme: dark)").matches&&r("dark")},[]),(0,a.useEffect)(()=>{let e=window.document.documentElement;"dark"===t?e.classList.add("dark"):e.classList.remove("dark"),localStorage.setItem("theme",t)},[t]),(0,o.jsx)(n.Provider,{value:{theme:t,toggleTheme:()=>{r(e=>"light"===e?"dark":"light")}},children:e})}function l(){let e=(0,a.useContext)(n);if(void 0===e)throw Error("useTheme must be used within a ThemeProvider");return e}},6872:()=>{}},e=>{e.O(0,[513,441,794,358],()=>e(e.s=2335)),_N_E=e.O()}]);