(()=>{var e,r,t,o,n,s,l={4098:(e,r,t)=>{"use strict";var o=t(4117),n=t(6927);function s(e){let r=0,t=0;e.forEach(e=>{r+=e.x,t+=e.y}),r/=e.length,t/=e.length;let n=0;e.forEach(e=>{n+=Math.sqrt((e.x-r)**2+(e.y-t)**2)});let s=Math.sqrt(2)/(n/=e.length),l=new o.uq([[s,0,-s*r],[0,s,-s*t],[0,0,1]]);return{points:e.map(e=>{let r=new o.uq([[e.x],[e.y],[1]]),t=l.mmul(r);return{x:t.get(0,0),y:t.get(1,0)}}),T:l}}let l=null,a=null,i=null,c=null,u=null,d=null,f=!1,g="";async function p(e){if(!f)return new Promise((r,t)=>{let o={onRuntimeInitialized:()=>{console.log("[Worker] OpenCV Runtime Initialized via Module callback"),d=self.cv&&self.cv.Mat?self.cv:o,f=!0,r()},onError:e=>{console.error("[Worker] OpenCV Module Error:",e)},print:e=>console.log("[OpenCV]",e),printErr:e=>console.warn("[OpenCV]",e)};self.Module=o,self.module=void 0,self.exports=void 0,self.define=void 0,self.window||(self.window=self);let n=0,s=setInterval(()=>{n++;let e=self.cv;e&&e.Mat?(clearInterval(s),f||(console.log("[Worker] OpenCV found via Polling"),d=e,f=!0,console.log("[Worker] Checking for findChessboardCorners..."),"function"==typeof d.findChessboardCorners?console.log("[Worker] findChessboardCorners is AVAILABLE"):(console.error("[Worker] findChessboardCorners is MISSING"),console.log("[Worker] Available keys (first 50):",Object.keys(d).slice(0,50)),console.log('[Worker] Keys matching "Chess":',Object.keys(d).filter(e=>e.includes("Chess")))),r())):"function"==typeof e&&!f&&n<5&&(console.log("[Worker] cv is function, attempting call..."),Promise.resolve(e(o)).then(e=>{d=e,f=!0,r()}).catch(()=>{})),n>200&&n%50==0&&console.warn("[Worker] Still waiting for OpenCV...")},100);console.log("[Worker] Loading OpenCV script...");try{let r=e||self.location.origin+"/",t=new URL("opencv.js",r).href;console.log(`[Worker] Importing OpenCV from: ${t}`),importScripts(t),console.log("[Worker] importScripts executed")}catch(e){console.warn("[Worker] Local load failed",e),t(Error(`Failed to load OpenCV from local: ${e}`))}})}let m=null;async function C(e,r){let{boardType:t}=r;if("aprilgrid"===t){if(!l){console.warn("[Worker] AprilTag module not ready yet, waiting...");for(let e=0;e<50&&!l;e++)await new Promise(e=>setTimeout(e,100));if(!l)throw Error("AprilTag not initialized after waiting")}return w({imageData:e})}if("checkerboard"===t||"chessboard"===t){if(await p(g),!d||!d.findChessboardCorners){console.warn("[Worker] OpenCV loaded but findChessboardCorners missing, waiting...");for(let e=0;e<50&&(!d||!d.findChessboardCorners);e++)self.Module&&self.Module.cv&&(d=self.Module.cv),self.cv&&self.cv.findChessboardCorners&&(d=self.cv),await new Promise(e=>setTimeout(e,100))}if(!d||!d.findChessboardCorners)if(self.cv&&self.cv.findChessboardCorners)d=self.cv;else{if(console.error("[Worker] OpenCV Keys:",d?Object.keys(d):"cv is null"),!d)throw Error("OpenCV failed to initialize (cv is null)");if(!d.findChessboardCorners)throw Error(`OpenCV initialized but missing findChessboardCorners. Available keys: ${Object.keys(d).slice(0,10).join(", ")}...`)}return function(e,r){try{let{rows:t,cols:o}=r;if(console.log(`[Worker] Detecting Chessboard: ${o}x${t} (inner corners)`),!d)return console.error("[Worker] OpenCV not loaded"),{found:!1,corners:[],error:"OpenCV not loaded"};let n=d.matFromImageData(e),s=new d.Mat;d.cvtColor(n,s,d.COLOR_RGBA2GRAY);let l=new d.Mat,a=new d.Size(o,t);console.log(`[Worker] Attempt 1: ${o}x${t}`);let i=d.findChessboardCorners(s,a,l,3);if(i||(console.log("[Worker] Attempt 1 failed. Trying (cols-1)x(rows-1)..."),a=new d.Size(o-1,t-1),i=d.findChessboardCorners(s,a,l,3)),i||(console.log("[Worker] Attempt 2 failed. Trying swapped cols/rows..."),a=new d.Size(t,o),i=d.findChessboardCorners(s,a,l,3)),i){console.log(`[Worker] Checkerboard found! Size: ${a.width}x${a.height}`);let e=new d.Size(5,5),r=new d.Size(-1,-1),t=new d.TermCriteria(d.TERM_CRITERIA_EPS+d.TERM_CRITERIA_COUNT,30,.001);d.cornerSubPix(s,l,e,r,t);let o=[];for(let e=0;e<l.rows;++e)o.push({x:l.data32F[2*e],y:l.data32F[2*e+1]});return n.delete(),s.delete(),l.delete(),{found:!0,corners:o}}return console.log("[Worker] Checkerboard NOT found."),n.delete(),s.delete(),l.delete(),{found:!1,corners:[],error:"Checkerboard pattern not found. Tried normal, inner-corners, and swapped dimensions."}}catch(e){return console.error("OpenCV Checkerboard Error:",e),{found:!1,corners:[],error:`OpenCV Error: ${e.message||e}`}}}(e,r)}if("charuco"===t)return await p(g),function(e,r){if(!d.aruco)return console.error("OpenCV build does not support ArUco"),{found:!1,error:"ArUco module not found in OpenCV build"};try{let{rows:t,cols:o,squareSize:n,markerSize:s,dictionary:l}=r,a=d.matFromImageData(e),i=new d.Mat;d.cvtColor(a,i,d.COLOR_RGBA2GRAY);let c=d.aruco.getPredefinedDictionary(d.aruco[l]),u=new d.aruco.CharucoBoard(o,t,n,s,c),f=new d.Mat,g=new d.Mat,p=new d.Mat,m=new d.aruco.DetectorParameters;if(d.aruco.detectMarkers(i,c,f,g,m,p),g.rows>0){let e=new d.Mat,r=new d.Mat;if(d.aruco.interpolateCornersCharuco(f,g,i,u,e,r)>0){let t=[];for(let o=0;o<e.rows;++o)t.push({x:e.data32F[2*o],y:e.data32F[2*o+1],id:r.data32S[o]});return a.delete(),i.delete(),f.delete(),g.delete(),p.delete(),e.delete(),r.delete(),u.delete(),m.delete(),c.delete(),{found:!0,corners:t,isCharuco:!0}}return a.delete(),i.delete(),f.delete(),g.delete(),p.delete(),u.delete(),m.delete(),{found:!1,corners:[],error:"Markers found but ChArUco board interpolation failed (count=0)."}}return a.delete(),i.delete(),f.delete(),g.delete(),p.delete(),u.delete(),m.delete(),{found:!1,corners:[],error:"No ArUco markers detected for ChArUco board."}}catch(e){return console.error("OpenCV ChArUco Error:",e),{found:!1,corners:[],error:`OpenCV ChArUco Error: ${e.message||e}`}}}(e,r);throw Error(`Unknown board type: ${t}`)}async function h(e){if(!l)return new Promise((r,t)=>{let o=new URL(e,self.location.origin).toString();self.postMessage({type:"LOG",message:`Loading script from: ${o}`}),self.Module={locateFile:e=>{if(e.endsWith(".wasm")){if(g){let e=new URL("apriltag.wasm",g).href;return self.postMessage({type:"LOG",message:`Locating WASM at: ${e}`}),e}return new URL("/apriltag.wasm",self.location.origin).toString()}return e},onRuntimeInitialized:()=>{console.log("AprilTag WASM Initialized"),self.postMessage({type:"LOG",message:"WASM Runtime Initialized"})}};try{importScripts(o),self.postMessage({type:"LOG",message:"importScripts executed successfully"})}catch(e){self.postMessage({type:"LOG",message:`importScripts failed: ${e.message}`}),t(e);return}let n=async()=>{if(self.AprilTagWasm){self.postMessage({type:"LOG",message:"AprilTagWasm factory found. Initializing module..."});try{l=await self.AprilTagWasm(self.Module),self.postMessage({type:"LOG",message:"Module awaited successfully"}),i=l.cwrap("atagjs_init","number",[]),l.cwrap("atagjs_destroy","number",[]),u=l.cwrap("atagjs_set_detector_options","number",["number","number","number","number","number","number","number"]),c=l.cwrap("atagjs_set_img_buffer","number",["number","number","number"]),a=l.cwrap("atagjs_detect","number",[]);let e=i();console.log("atag_init returned:",e),u(2,0,1,1,10,0,0),console.log("AprilTag WASM Initialized (Safe Options Set)"),r()}catch(e){self.postMessage({type:"LOG",message:`WASM Module Instantiation failed: ${e.message}`}),t(e)}}else setTimeout(n,100)};n()})}function w({imageData:e}){let{width:r,height:t,data:o}=e,n=new Uint8Array(r*t);for(let e=0;e<r*t;e++){let r=o[4*e],t=o[4*e+1],s=o[4*e+2];n[e]=.299*r+.587*t+.114*s}console.log(`[Worker] Image size: ${r}x${t}, Buffer size: ${n.length}`);let s=c(r,t,r);if(0===s)throw Error("Failed to allocate memory for image in WASM");l.HEAPU8.set(n,s);let i=a();if(console.log("[Worker] Detect Result Ptr:",i),0===i)return console.error("[Worker] Detection failed: returned NULL pointer"),{found:!1,detections:[],error:"WASM Internal Error: Returned NULL pointer"};let u=l.getValue(i,"i32"),d=l.getValue(i+4,"i32");if(console.log("[Worker] JSON Ptr:",u,"Len:",d),d>0&&0!==u)try{let e=l.HEAPU8.subarray(u,u+d),r=new TextDecoder("utf8").decode(e);if(console.log("[Worker] JSON String Start:",r.substring(0,100)),!(r=r.replace(/\u0000/g,"")).trim().startsWith("["))return console.error("[Worker] Invalid JSON format (does not start with [). Full string:",r),{found:!1,detections:[],error:`WASM Output Error: ${r}`};let t=JSON.parse(r);if(0===t.length)return{found:!1,detections:[],error:"No AprilTags detected"};return{found:t.length>0,detections:t}}catch(e){return console.error("[Worker] JSON Parse Error:",e.message),{found:!1,detections:[],error:`JSON Parse Error: ${e.message}`}}return{found:!1,detections:[],error:"No detection result returned from WASM"}}self.onmessage=async e=>{let{type:r,payload:t,id:a}=e.data;try{switch(r){case"INIT":self.postMessage({type:"LOG",message:`INIT received. URL: ${t.url}`}),t.baseUrl&&(g=t.baseUrl,self.postMessage({type:"LOG",message:`Global Base URL set to: ${g}`})),m=h(t.url),await m,self.postMessage({type:"INIT_SUCCESS",id:a});break;case"DETECT":m&&await m;let e=await C(t.imageData,t.settings);self.postMessage({type:"DETECT_SUCCESS",id:a,payload:e});break;case"DETECT_TAGS":if(!l)throw Error("AprilTag not initialized");let i=w(t);self.postMessage({type:"DETECT_SUCCESS",id:a,payload:i});break;case"CALIBRATE":let c=function(e,r,t){let l,a,i,c,u,d,f,g,p,m,C,h,w,y,b=[],{points:S,T:k}=s(r);for(let r of e){let{points:e,T:t}=s(r),n=function(e,r){let t=e.length,n=[];for(let o=0;o<t;o++){let t=e[o].x,s=e[o].y,l=r[o].x,a=r[o].y;n.push([-t,-s,-1,0,0,0,l*t,l*s,l]),n.push([0,0,0,-t,-s,-1,a*t,a*s,a])}let s=new o.uq(n),l=new o.W2(s).rightSingularVectors.getColumn(8),a=new o.uq(3,3);return a.set(0,0,l[0]),a.set(0,1,l[1]),a.set(0,2,l[2]),a.set(1,0,l[3]),a.set(1,1,l[4]),a.set(1,2,l[5]),a.set(2,0,l[6]),a.set(2,1,l[7]),a.set(2,2,l[8]),a}(S,e),l=(0,o.DI)(t).mmul(n).mmul(k);l.div(l.get(2,2)),b.push(l)}let O=(l=new o.uq(2*b.length,6),a=(e,r,t)=>{let o=e.getColumn(r),n=e.getColumn(t);return[o[0]*n[0],o[0]*n[1]+o[1]*n[0],o[1]*n[1],o[2]*n[0]+o[0]*n[2],o[2]*n[1]+o[1]*n[2],o[2]*n[2]]},b.forEach((e,r)=>{let t=a(e,0,1),o=a(e,0,0),n=a(e,1,1),s=o.map((e,r)=>e-n[r]);for(let e=0;e<6;e++)l.set(2*r,e,t[e]),l.set(2*r+1,e,s[e])}),c=(i=new o.W2(l).rightSingularVectors.getColumn(5))[0],u=i[1],d=i[2],f=i[3],g=i[4],p=i[5],m=(u*f-c*g)/(c*d-u*u),C=p-(f*f+m*(u*f-c*g))/c,h=Math.sqrt(C/c),w=Math.sqrt(C*c/(c*d-u*u)),y=-u*h*h*w/C,{fx:h,fy:w,cx:y*m/w-f*h*h/C,cy:m,skew:y}),M=new o.uq([[O.fx,O.skew,O.cx],[0,O.fy,O.cy],[0,0,1]]),v=b.map(e=>(function(e,r){let t=(0,o.DI)(r),n=e.getColumn(0),s=e.getColumn(1),l=e.getColumn(2),a=new o.uq(3,1);for(let e=0;e<3;e++)a.set(e,0,n[e]);a.norm();let i=new o.uq(3,1);for(let e=0;e<3;e++)i.set(e,0,n[e]);let c=new o.uq(3,1);for(let e=0;e<3;e++)c.set(e,0,s[e]);let u=new o.uq(3,1);for(let e=0;e<3;e++)u.set(e,0,l[e]);let d=t.mmul(i),f=t.mmul(c),g=t.mmul(u),p=1/d.norm(),m=d.mul(p),C=f.mul(p),h=new o.uq([[m.get(1,0)*C.get(2,0)-m.get(2,0)*C.get(1,0)],[m.get(2,0)*C.get(0,0)-m.get(0,0)*C.get(2,0)],[m.get(0,0)*C.get(1,0)-m.get(1,0)*C.get(0,0)]]),w=g.mul(p),y=new o.uq(3,3);y.setColumn(0,m.to1DArray()),y.setColumn(1,C.to1DArray()),y.setColumn(2,h.to1DArray());let b=new o.W2(y);return{R:b.leftSingularVectors.mmul(b.rightSingularVectors.transpose()),t:w}})(e,M)),E=[O.fx,O.fy,O.cx,O.cy,0,0],A=[],W=[];e.forEach((e,r)=>{e.forEach((e,t)=>{A.push([r,t,0]),W.push(e.x),A.push([r,t,1]),W.push(e.y)})});let T=(0,n.s)({x:A,y:W},(e,t)=>{let[n,s,l,a,i,c]=t;return e.map(e=>{let t=e[0],u=e[1],d=1===e[2],{R:f,t:g}=v[t],p=r[u],m=new o.uq([[p.x],[p.y],[0]]),C=f.mmul(m).add(g),h=C.get(0,0)/C.get(2,0),w=C.get(1,0)/C.get(2,0),y=h*h+w*w,b=y*y;return d?w*(1+i*y+c*b)*s+a:h*(1+i*y+c*b)*n+l})},{damping:1.5,initialValues:E,gradientDifference:.1,maxIterations:50,errorTolerance:.01}),[x,I,L,R,_,V]=T.parameterValues;return{cameraMatrix:[x,0,L,0,I,R,0,0,1],distCoeffs:[_,V,0,0,0],rms:T.parameterError,rvecs:v.map(e=>[0,0,0]),tvecs:v.map(e=>[e.t.get(0,0),e.t.get(1,0),e.t.get(2,0)])}}(t.allImagePoints,t.objPoints,t.imageSize);self.postMessage({type:"CALIBRATE_SUCCESS",id:a,payload:c});break;default:throw Error(`Unknown message type: ${r}`)}}catch(e){self.postMessage({type:"ERROR",id:a,error:e.message})}}}},a={};function i(e){var r=a[e];if(void 0!==r)return r.exports;var t=a[e]={exports:{}},o=!0;try{l[e](t,t.exports,i),o=!1}finally{o&&delete a[e]}return t.exports}i.m=l,i.x=()=>{var e=i.O(void 0,[927],()=>i(4098));return i.O(e)},e=[],i.O=(r,t,o,n)=>{if(t){n=n||0;for(var s=e.length;s>0&&e[s-1][2]>n;s--)e[s]=e[s-1];e[s]=[t,o,n];return}for(var l=1/0,s=0;s<e.length;s++){for(var[t,o,n]=e[s],a=!0,c=0;c<t.length;c++)(!1&n||l>=n)&&Object.keys(i.O).every(e=>i.O[e](t[c]))?t.splice(c--,1):(a=!1,n<l&&(l=n));if(a){e.splice(s--,1);var u=o();void 0!==u&&(r=u)}}return r},i.d=(e,r)=>{for(var t in r)i.o(r,t)&&!i.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce((r,t)=>(i.f[t](e,r),r),[])),i.u=e=>"static/chunks/"+e+".3fd8a9bb48a63997.js",i.miniCssF=e=>{},i.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.tt=()=>(void 0===r&&(r={createScriptURL:e=>e},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(r=trustedTypes.createPolicy("nextjs#bundler",r))),r),i.tu=e=>i.tt().createScriptURL(e),i.p="/camera_calibrator/_next/",t={98:1},i.f.i=(e,r)=>{t[e]||importScripts(i.tu(i.p+i.u(e)))},n=(o=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(o),o.push=e=>{var[r,o,s]=e;for(var l in o)i.o(o,l)&&(i.m[l]=o[l]);for(s&&s(i);r.length;)t[r.pop()]=1;n(e)},s=i.x,i.x=()=>i.e(927).then(s),_N_E=i.x()})();