(()=>{var e,r,t,o,n,l,s={4098:(e,r,t)=>{"use strict";var o=t(4117),n=t(6927);function l(e){let r=0,t=0;e.forEach(e=>{r+=e.x,t+=e.y}),r/=e.length,t/=e.length;let n=0;e.forEach(e=>{n+=Math.sqrt((e.x-r)**2+(e.y-t)**2)});let l=Math.sqrt(2)/(n/=e.length),s=new o.uq([[l,0,-l*r],[0,l,-l*t],[0,0,1]]);return{points:e.map(e=>{let r=new o.uq([[e.x],[e.y],[1]]),t=s.mmul(r);return{x:t.get(0,0),y:t.get(1,0)}}),T:s}}let s=null,a=null,i=null,c=null,u=null,d=null,f=!1;async function g(){if(!f)return new Promise((e,r)=>{let t={onRuntimeInitialized:()=>{console.log("[Worker] OpenCV Runtime Initialized via Module callback"),d=self.cv&&self.cv.Mat?self.cv:t,f=!0,e()},onError:e=>{console.error("[Worker] OpenCV Module Error:",e)},print:e=>console.log("[OpenCV]",e),printErr:e=>console.warn("[OpenCV]",e)};self.Module=t,self.module=void 0,self.exports=void 0,self.define=void 0,self.window||(self.window=self);let o=0,n=setInterval(()=>{o++;let r=self.cv;r&&r.Mat?(clearInterval(n),f||(console.log("[Worker] OpenCV found via Polling"),d=r,f=!0,console.log("[Worker] Checking for findChessboardCorners..."),"function"==typeof d.findChessboardCorners?console.log("[Worker] findChessboardCorners is AVAILABLE"):(console.error("[Worker] findChessboardCorners is MISSING"),console.log("[Worker] Available keys (first 50):",Object.keys(d).slice(0,50)),console.log('[Worker] Keys matching "Chess":',Object.keys(d).filter(e=>e.includes("Chess")))),e())):"function"==typeof r&&!f&&o<5&&(console.log("[Worker] cv is function, attempting call..."),Promise.resolve(r(t)).then(r=>{d=r,f=!0,e()}).catch(()=>{})),o>200&&o%50==0&&console.warn("[Worker] Still waiting for OpenCV...")},100);console.log("[Worker] Loading OpenCV script...");try{let e=self.location.origin;importScripts(`${e}/opencv.js`),console.log("[Worker] importScripts executed")}catch(e){console.warn("[Worker] Local load failed, trying CDN",e);try{importScripts("https://docs.opencv.org/4.5.0/opencv.js")}catch(e){r(Error(`Failed to load OpenCV: ${e}`))}}})}async function p(e,r){let{boardType:t}=r;if("aprilgrid"===t){if(!s)throw Error("AprilTag not initialized");return h({imageData:e})}if("checkerboard"===t||"chessboard"===t)return await g(),function(e,r){try{let{rows:t,cols:o}=r;if(console.log(`[Worker] Detecting Chessboard: ${o}x${t} (inner corners)`),!d)return console.error("[Worker] OpenCV not loaded"),{found:!1,corners:[],error:"OpenCV not loaded"};let n=d.matFromImageData(e),l=new d.Mat;d.cvtColor(n,l,d.COLOR_RGBA2GRAY);let s=new d.Mat,a=new d.Size(o,t);console.log(`[Worker] Attempt 1: ${o}x${t}`);let i=d.findChessboardCorners(l,a,s,3);if(i||(console.log("[Worker] Attempt 1 failed. Trying (cols-1)x(rows-1)..."),a=new d.Size(o-1,t-1),i=d.findChessboardCorners(l,a,s,3)),i||(console.log("[Worker] Attempt 2 failed. Trying swapped cols/rows..."),a=new d.Size(t,o),i=d.findChessboardCorners(l,a,s,3)),i){console.log(`[Worker] Checkerboard found! Size: ${a.width}x${a.height}`);let e=new d.Size(5,5),r=new d.Size(-1,-1),t=new d.TermCriteria(d.TERM_CRITERIA_EPS+d.TERM_CRITERIA_COUNT,30,.001);d.cornerSubPix(l,s,e,r,t);let o=[];for(let e=0;e<s.rows;++e)o.push({x:s.data32F[2*e],y:s.data32F[2*e+1]});return n.delete(),l.delete(),s.delete(),{found:!0,corners:o}}return console.log("[Worker] Checkerboard NOT found."),n.delete(),l.delete(),s.delete(),{found:!1,corners:[],error:"Checkerboard pattern not found. Tried normal, inner-corners, and swapped dimensions."}}catch(e){return console.error("OpenCV Checkerboard Error:",e),{found:!1,corners:[],error:`OpenCV Error: ${e.message||e}`}}}(e,r);if("charuco"===t)return await g(),function(e,r){if(!d.aruco)return console.error("OpenCV build does not support ArUco"),{found:!1,error:"ArUco module not found in OpenCV build"};try{let{rows:t,cols:o,squareSize:n,markerSize:l,dictionary:s}=r,a=d.matFromImageData(e),i=new d.Mat;d.cvtColor(a,i,d.COLOR_RGBA2GRAY);let c=d.aruco.getPredefinedDictionary(d.aruco[s]),u=new d.aruco.CharucoBoard(o,t,n,l,c),f=new d.Mat,g=new d.Mat,p=new d.Mat,m=new d.aruco.DetectorParameters;if(d.aruco.detectMarkers(i,c,f,g,m,p),g.rows>0){let e=new d.Mat,r=new d.Mat;if(d.aruco.interpolateCornersCharuco(f,g,i,u,e,r)>0){let t=[];for(let o=0;o<e.rows;++o)t.push({x:e.data32F[2*o],y:e.data32F[2*o+1],id:r.data32S[o]});return a.delete(),i.delete(),f.delete(),g.delete(),p.delete(),e.delete(),r.delete(),u.delete(),m.delete(),c.delete(),{found:!0,corners:t,isCharuco:!0}}return a.delete(),i.delete(),f.delete(),g.delete(),p.delete(),u.delete(),m.delete(),{found:!1,corners:[],error:"Markers found but ChArUco board interpolation failed (count=0)."}}return a.delete(),i.delete(),f.delete(),g.delete(),p.delete(),u.delete(),m.delete(),{found:!1,corners:[],error:"No ArUco markers detected for ChArUco board."}}catch(e){return console.error("OpenCV ChArUco Error:",e),{found:!1,corners:[],error:`OpenCV ChArUco Error: ${e.message||e}`}}}(e,r);throw Error(`Unknown board type: ${t}`)}async function m(e){if(!s)return new Promise((r,t)=>{let o=new URL(e,self.location.origin).toString();self.Module={locateFile:e=>e.endsWith(".wasm")?new URL("/apriltag.wasm",self.location.origin).toString():e,onRuntimeInitialized:()=>{console.log("AprilTag WASM Initialized")}},importScripts(o);let n=async()=>{self.AprilTagWasm?(i=(s=await self.AprilTagWasm(self.Module)).cwrap("atagjs_init","number",[]),s.cwrap("atagjs_destroy","number",[]),u=s.cwrap("atagjs_set_detector_options","number",["number","number","number","number","number","number","number"]),c=s.cwrap("atagjs_set_img_buffer","number",["number","number","number"]),a=s.cwrap("atagjs_detect","number",[]),console.log("atag_init returned:",i()),u(2,0,1,1,10,0,0),console.log("AprilTag WASM Initialized (Safe Options Set)"),r()):setTimeout(n,100)};n()})}function h({imageData:e}){let{width:r,height:t,data:o}=e,n=new Uint8Array(r*t);for(let e=0;e<r*t;e++){let r=o[4*e],t=o[4*e+1],l=o[4*e+2];n[e]=.299*r+.587*t+.114*l}console.log(`[Worker] Image size: ${r}x${t}, Buffer size: ${n.length}`);let l=c(r,t,r);if(0===l)throw Error("Failed to allocate memory for image in WASM");s.HEAPU8.set(n,l);let i=a();if(console.log("[Worker] Detect Result Ptr:",i),0===i)return console.error("[Worker] Detection failed: returned NULL pointer"),{found:!1,detections:[],error:"WASM Internal Error: Returned NULL pointer"};let u=s.getValue(i,"i32"),d=s.getValue(i+4,"i32");if(console.log("[Worker] JSON Ptr:",u,"Len:",d),d>0&&0!==u)try{let e=s.HEAPU8.subarray(u,u+d),r=new TextDecoder("utf8").decode(e);if(console.log("[Worker] JSON String Start:",r.substring(0,100)),!(r=r.replace(/\u0000/g,"")).trim().startsWith("["))return console.error("[Worker] Invalid JSON format (does not start with [). Full string:",r),{found:!1,detections:[],error:`WASM Output Error: ${r}`};let t=JSON.parse(r);if(0===t.length)return{found:!1,detections:[],error:"No AprilTags detected"};return{found:t.length>0,detections:t}}catch(e){return console.error("[Worker] JSON Parse Error:",e.message),{found:!1,detections:[],error:`JSON Parse Error: ${e.message}`}}return{found:!1,detections:[],error:"No detection result returned from WASM"}}self.onmessage=async e=>{let{type:r,payload:t,id:a}=e.data;try{switch(r){case"INIT":await m(t.url),self.postMessage({type:"INIT_SUCCESS",id:a});break;case"DETECT":let e=await p(t.imageData,t.settings);self.postMessage({type:"DETECT_SUCCESS",id:a,payload:e});break;case"DETECT_TAGS":if(!s)throw Error("AprilTag not initialized");let i=h(t);self.postMessage({type:"DETECT_SUCCESS",id:a,payload:i});break;case"CALIBRATE":let c=function(e,r,t){let s,a,i,c,u,d,f,g,p,m,h,C,w,y,b=[],{points:S,T:k}=l(r);for(let r of e){let{points:e,T:t}=l(r),n=function(e,r){let t=e.length,n=[];for(let o=0;o<t;o++){let t=e[o].x,l=e[o].y,s=r[o].x,a=r[o].y;n.push([-t,-l,-1,0,0,0,s*t,s*l,s]),n.push([0,0,0,-t,-l,-1,a*t,a*l,a])}let l=new o.uq(n),s=new o.W2(l).rightSingularVectors.getColumn(8),a=new o.uq(3,3);return a.set(0,0,s[0]),a.set(0,1,s[1]),a.set(0,2,s[2]),a.set(1,0,s[3]),a.set(1,1,s[4]),a.set(1,2,s[5]),a.set(2,0,s[6]),a.set(2,1,s[7]),a.set(2,2,s[8]),a}(S,e),s=(0,o.DI)(t).mmul(n).mmul(k);s.div(s.get(2,2)),b.push(s)}let E=(s=new o.uq(2*b.length,6),a=(e,r,t)=>{let o=e.getColumn(r),n=e.getColumn(t);return[o[0]*n[0],o[0]*n[1]+o[1]*n[0],o[1]*n[1],o[2]*n[0]+o[0]*n[2],o[2]*n[1]+o[1]*n[2],o[2]*n[2]]},b.forEach((e,r)=>{let t=a(e,0,1),o=a(e,0,0),n=a(e,1,1),l=o.map((e,r)=>e-n[r]);for(let e=0;e<6;e++)s.set(2*r,e,t[e]),s.set(2*r+1,e,l[e])}),c=(i=new o.W2(s).rightSingularVectors.getColumn(5))[0],u=i[1],d=i[2],f=i[3],g=i[4],p=i[5],m=(u*f-c*g)/(c*d-u*u),h=p-(f*f+m*(u*f-c*g))/c,C=Math.sqrt(h/c),w=Math.sqrt(h*c/(c*d-u*u)),y=-u*C*C*w/h,{fx:C,fy:w,cx:y*m/w-f*C*C/h,cy:m,skew:y}),O=new o.uq([[E.fx,E.skew,E.cx],[0,E.fy,E.cy],[0,0,1]]),A=b.map(e=>(function(e,r){let t=(0,o.DI)(r),n=e.getColumn(0),l=e.getColumn(1),s=e.getColumn(2),a=new o.uq(3,1);for(let e=0;e<3;e++)a.set(e,0,n[e]);a.norm();let i=new o.uq(3,1);for(let e=0;e<3;e++)i.set(e,0,n[e]);let c=new o.uq(3,1);for(let e=0;e<3;e++)c.set(e,0,l[e]);let u=new o.uq(3,1);for(let e=0;e<3;e++)u.set(e,0,s[e]);let d=t.mmul(i),f=t.mmul(c),g=t.mmul(u),p=1/d.norm(),m=d.mul(p),h=f.mul(p),C=new o.uq([[m.get(1,0)*h.get(2,0)-m.get(2,0)*h.get(1,0)],[m.get(2,0)*h.get(0,0)-m.get(0,0)*h.get(2,0)],[m.get(0,0)*h.get(1,0)-m.get(1,0)*h.get(0,0)]]),w=g.mul(p),y=new o.uq(3,3);y.setColumn(0,m.to1DArray()),y.setColumn(1,h.to1DArray()),y.setColumn(2,C.to1DArray());let b=new o.W2(y);return{R:b.leftSingularVectors.mmul(b.rightSingularVectors.transpose()),t:w}})(e,O)),v=[E.fx,E.fy,E.cx,E.cy,0,0],T=[],W=[];e.forEach((e,r)=>{e.forEach((e,t)=>{T.push([r,t,0]),W.push(e.x),T.push([r,t,1]),W.push(e.y)})});let x=(0,n.s)({x:T,y:W},(e,t)=>{let[n,l,s,a,i,c]=t;return e.map(e=>{let t=e[0],u=e[1],d=1===e[2],{R:f,t:g}=A[t],p=r[u],m=new o.uq([[p.x],[p.y],[0]]),h=f.mmul(m).add(g),C=h.get(0,0)/h.get(2,0),w=h.get(1,0)/h.get(2,0),y=C*C+w*w,b=y*y;return d?w*(1+i*y+c*b)*l+a:C*(1+i*y+c*b)*n+s})},{damping:1.5,initialValues:v,gradientDifference:.1,maxIterations:50,errorTolerance:.01}),[M,_,I,R,V,P]=x.parameterValues;return{cameraMatrix:[M,0,I,0,_,R,0,0,1],distCoeffs:[V,P,0,0,0],rms:x.parameterError,rvecs:A.map(e=>[0,0,0]),tvecs:A.map(e=>[e.t.get(0,0),e.t.get(1,0),e.t.get(2,0)])}}(t.allImagePoints,t.objPoints,t.imageSize);self.postMessage({type:"CALIBRATE_SUCCESS",id:a,payload:c});break;default:throw Error(`Unknown message type: ${r}`)}}catch(e){self.postMessage({type:"ERROR",id:a,error:e.message})}}}},a={};function i(e){var r=a[e];if(void 0!==r)return r.exports;var t=a[e]={exports:{}},o=!0;try{s[e](t,t.exports,i),o=!1}finally{o&&delete a[e]}return t.exports}i.m=s,i.x=()=>{var e=i.O(void 0,[927],()=>i(4098));return i.O(e)},e=[],i.O=(r,t,o,n)=>{if(t){n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[t,o,n];return}for(var s=1/0,l=0;l<e.length;l++){for(var[t,o,n]=e[l],a=!0,c=0;c<t.length;c++)(!1&n||s>=n)&&Object.keys(i.O).every(e=>i.O[e](t[c]))?t.splice(c--,1):(a=!1,n<s&&(s=n));if(a){e.splice(l--,1);var u=o();void 0!==u&&(r=u)}}return r},i.d=(e,r)=>{for(var t in r)i.o(r,t)&&!i.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce((r,t)=>(i.f[t](e,r),r),[])),i.u=e=>"static/chunks/"+e+".3fd8a9bb48a63997.js",i.miniCssF=e=>{},i.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.tt=()=>(void 0===r&&(r={createScriptURL:e=>e},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(r=trustedTypes.createPolicy("nextjs#bundler",r))),r),i.tu=e=>i.tt().createScriptURL(e),i.p="/camera_calibrator/_next/",t={98:1},i.f.i=(e,r)=>{t[e]||importScripts(i.tu(i.p+i.u(e)))},n=(o=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(o),o.push=e=>{var[r,o,l]=e;for(var s in o)i.o(o,s)&&(i.m[s]=o[s]);for(l&&l(i);r.length;)t[r.pop()]=1;n(e)},l=i.x,i.x=()=>i.e(927).then(l),_N_E=i.x()})();